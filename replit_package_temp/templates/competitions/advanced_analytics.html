{% extends 'base/base.html' %}

{% block title %}๐ ุงูุชุญูููุงุช ุงููุชูุฏูุฉ - ููุตุฉ ุงูุญุณุงุจ{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white border-0 shadow-lg">
                <div class="card-body text-center py-5">
                    <h1 class="display-4 mb-3">
                        <i class="fas fa-chart-line me-3"></i>
                        ๐ ุงูุชุญูููุงุช ุงููุชูุฏูุฉ
                    </h1>
                    <p class="lead fs-4">ุชุญููู ุดุงูู ูุฃุฏุงุก ุงููุดุงุฑููู ูุงูุนูููุงุช ุงูุญุณุงุจูุฉ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Grade Level Statistics with Charts -->
    <div class="row mb-5">
        <!-- Charts Section -->
        <div class="col-md-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="fas fa-chart-bar text-primary me-2"></i>
                        ๐ ุงูุฑุณูู ุงูุจูุงููุฉ ูููุณุชููุงุช ุงูุฏุฑุงุณูุฉ
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Chart Navigation -->
                    <div class="btn-group mb-3" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="showChart('participantsChart')">
                            ๐ฅ ุงููุดุงุฑููู
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="showChart('successRateChart')">
                            โ ูุนุฏู ุงููุฌุงุญ
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="showChart('responseTimeChart')">
                            โฑ๏ธ ููุช ุงูุฅุฌุงุจุฉ
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="showChart('competitionsChart')">
                            ๐ ุงููุณุงุจูุงุช
                        </button>
                    </div>

                    <!-- Charts Container -->
                    <div style="height: 400px;">
                        <canvas id="participantsChart" class="chart-canvas"></canvas>
                        <canvas id="successRateChart" class="chart-canvas" style="display: none;"></canvas>
                        <canvas id="responseTimeChart" class="chart-canvas" style="display: none;"></canvas>
                        <canvas id="competitionsChart" class="chart-canvas" style="display: none;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="col-md-4">
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="card bg-gradient-primary text-white border-0">
                        <div class="card-body text-center">
                            <h2 class="mb-1">{{ grade_stats|length }}</h2>
                            <p class="mb-0">ูุณุชููุงุช ุฏุฑุงุณูุฉ</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 mb-3">
                    <div class="card bg-gradient-success text-white border-0">
                        <div class="card-body text-center">
                            <h2 class="mb-1" id="totalParticipants">-</h2>
                            <p class="mb-0">ุฅุฌูุงูู ุงููุดุงุฑููู</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 mb-3">
                    <div class="card bg-gradient-warning text-white border-0">
                        <div class="card-body text-center">
                            <h2 class="mb-1" id="totalCompetitions">-</h2>
                            <p class="mb-0">ุฅุฌูุงูู ุงููุณุงุจูุงุช</p>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card bg-gradient-info text-white border-0">
                        <div class="card-body text-center">
                            <h2 class="mb-1">
                                {% widthratio grade_stats|length 1 grade_stats|length as avg_success %}
                                {% for grade in grade_stats %}
                                    {% if forloop.first %}{{ grade.success_rate|floatformat:1 }}%{% endif %}
                                {% endfor %}
                            </h2>
                            <p class="mb-0">ูุชูุณุท ุงููุฌุงุญ ุงูุนุงู</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Table -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="fas fa-table text-secondary me-2"></i>
                        ๐ ุฌุฏูู ุชูุตููู ูููุณุชููุงุช ุงูุฏุฑุงุณูุฉ
                    </h3>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="exportToExcel()">
                            <i class="fas fa-file-excel me-1"></i>
                            ๐ ุชุตุฏูุฑ Excel
                        </button>
                        <a href="{% url 'competitions:export_grade_analytics_excel' %}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-download me-1"></i>
                            ุชุตุฏูุฑ ุดุงูู
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="gradeStatsTable" class="table table-hover">
                            <thead class="table-primary">
                                <tr>
                                    <th>ุงููุณุชูู ุงูุฏุฑุงุณู</th>
                                    <th>ุนุฏุฏ ุงููุดุงุฑููู</th>
                                    <th>ุฅุฌูุงูู ุงููุณุงุจูุงุช</th>
                                    <th>ูุชูุณุท ููุช ุงูุฅุฌุงุจุฉ (ุซุงููุฉ)</th>
                                    <th>ูุนุฏู ุงููุฌุงุญ (%)</th>
                                    <th>ุฅุฌูุงูู ุงูุฃุณุฆูุฉ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for grade in grade_stats %}
                                <tr>
                                    <td>
                                        <span class="badge bg-primary fs-6">{{ grade.grade_display }}</span>
                                    </td>
                                    <td>
                                        <i class="fas fa-users text-info me-1"></i>
                                        {{ grade.participant_count }}
                                    </td>
                                    <td>
                                        <i class="fas fa-trophy text-warning me-1"></i>
                                        {{ grade.total_competitions }}
                                    </td>
                                    <td>
                                        <span class="badge {% if grade.avg_response_time <= 10 %}bg-success{% elif grade.avg_response_time <= 15 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ grade.avg_response_time }}s
                                        </span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar {% if grade.success_rate >= 80 %}bg-success{% elif grade.success_rate >= 60 %}bg-warning{% else %}bg-danger{% endif %}"
                                                 style="width: {{ grade.success_rate }}%">
                                                {{ grade.success_rate }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ grade.total_questions }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>
                                        ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุงุญุฉ
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Operations Analysis with Charts -->
    <div class="row mb-5">
        <!-- Operations Chart -->
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="fas fa-chart-pie text-success me-2"></i>
                        ๐งฎ ุฑุณู ุจูุงูู ููุนูููุงุช ุงูุญุณุงุจูุฉ
                    </h3>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="operationsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Operations Performance Chart -->
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="fas fa-chart-bar text-warning me-2"></i>
                        ๐ ุฃุฏุงุก ุงูุนูููุงุช ุงูุญุณุงุจูุฉ
                    </h3>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="operationsPerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Operations Detailed Table -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="fas fa-table text-success me-2"></i>
                        ๐ ุฌุฏูู ุชูุตููู ููุนูููุงุช ุงูุญุณุงุจูุฉ
                    </h3>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="exportOperationsToExcel()">
                            <i class="fas fa-file-excel me-1"></i>
                            ๐ ุชุตุฏูุฑ Excel
                        </button>
                        <a href="{% url 'competitions:export_operations_analytics_excel' %}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-download me-1"></i>
                            ุชุตุฏูุฑ ุดุงูู
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="operationsTable" class="table table-hover">
                            <thead class="table-success">
                                <tr>
                                    <th>ุงูุนูููุฉ</th>
                                    <th>ุนุฏุฏ ุงูุฃุณุฆูุฉ</th>
                                    <th>ูุนุฏู ุงููุฌุงุญ</th>
                                    <th>ูุชูุณุท ุงูููุช</th>
                                    <th>ููุงุท ุงูููุฉ</th>
                                    <th>ููุงุท ุงูุถุนู</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for op in operations_analysis %}
                                <tr>
                                    <td>
                                        <span class="badge bg-success fs-6">
                                            {% if op.operation == 'addition' %}
                                                <i class="fas fa-plus me-1"></i>
                                            {% elif op.operation == 'subtraction' %}
                                                <i class="fas fa-minus me-1"></i>
                                            {% elif op.operation == 'multiplication' %}
                                                <i class="fas fa-times me-1"></i>
                                            {% elif op.operation == 'division' %}
                                                <i class="fas fa-divide me-1"></i>
                                            {% endif %}
                                            {{ op.operation_name }}
                                        </span>
                                    </td>
                                    <td>{{ op.questions_count }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar {% if op.success_rate >= 80 %}bg-success{% elif op.success_rate >= 60 %}bg-warning{% else %}bg-danger{% endif %}"
                                                 style="width: {{ op.success_rate }}%">
                                                {{ op.success_rate }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge {% if op.avg_time <= 10 %}bg-success{% elif op.avg_time <= 15 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ op.avg_time }}s
                                        </span>
                                    </td>
                                    <td>
                                        {% for strength in op.strengths %}
                                            <span class="badge bg-success me-1 mb-1">โ {{ strength }}</span>
                                        {% empty %}
                                            <span class="text-muted">-</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {% for weakness in op.weaknesses %}
                                            <span class="badge bg-danger me-1 mb-1">โ {{ weakness }}</span>
                                        {% empty %}
                                            <span class="text-muted">-</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Time-Based Analytics -->
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light">
                    <h4 class="mb-0">
                        <i class="fas fa-clock text-warning me-2"></i>
                        โฑ๏ธ ุฃุณุฑุน ุงููุดุงุฑููู
                    </h4>
                </div>
                <div class="card-body">
                    {% for participant in time_analytics.fastest_participants %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>
                            <i class="fas fa-medal text-warning me-2"></i>
                            {{ participant.competition__participant__name }}
                        </span>
                        <span class="badge bg-success">{{ participant.avg_time|floatformat:2 }}s</span>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุงุญุฉ</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line text-info me-2"></i>
                        ๐ ุชุญุณู ุงูุฃุฏุงุก
                    </h4>
                </div>
                <div class="card-body">
                    {% for improvement in time_analytics.improvement_data %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>
                            <i class="fas fa-user text-info me-2"></i>
                            {{ improvement.participant }}
                        </span>
                        <span class="badge {% if improvement.improvement > 0 %}bg-success{% else %}bg-danger{% endif %}">
                            {% if improvement.improvement > 0 %}+{% endif %}{{ improvement.improvement }}%
                        </span>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุงุญุฉ</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Top Performers -->
    <div class="row mb-5">
        <div class="col-md-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light">
                    <h4 class="mb-0">
                        <i class="fas fa-target text-success me-2"></i>
                        ๐ฏ ุงูุฃุนูู ุฏูุฉ
                    </h4>
                </div>
                <div class="card-body">
                    {% for participant in top_performers.top_by_accuracy %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>
                            <a href="{% url 'competitions:participant_profile' participant.id %}" class="text-decoration-none">
                                <i class="fas fa-user text-success me-2"></i>
                                {{ participant.name }}
                            </a>
                        </span>
                        <span class="badge bg-success">{{ participant.accuracy|floatformat:1 }}%</span>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุงุญุฉ</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light">
                    <h4 class="mb-0">
                        <i class="fas fa-tachometer-alt text-warning me-2"></i>
                        โก ุงูุฃุณุฑุน
                    </h4>
                </div>
                <div class="card-body">
                    {% for participant in top_performers.top_by_speed %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>
                            <a href="{% url 'competitions:participant_profile' participant.id %}" class="text-decoration-none">
                                <i class="fas fa-user text-warning me-2"></i>
                                {{ participant.name }}
                            </a>
                        </span>
                        <span class="badge bg-warning">{{ participant.avg_response_time|floatformat:2 }}s</span>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุงุญุฉ</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light">
                    <h4 class="mb-0">
                        <i class="fas fa-trophy text-primary me-2"></i>
                        ๐ ุงูุฃูุซุฑ ูุดุงุฑูุฉ
                    </h4>
                </div>
                <div class="card-body">
                    {% for participant in top_performers.top_by_participation %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>
                            <a href="{% url 'competitions:participant_profile' participant.id %}" class="text-decoration-none">
                                <i class="fas fa-user text-primary me-2"></i>
                                {{ participant.name }}
                            </a>
                        </span>
                        <span class="badge bg-primary">{{ participant.competition_count }}</span>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุงุญุฉ</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row">
        <div class="col-12 text-center">
            <div class="btn-group me-3" role="group">
                <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-2"></i>
                    ๐ ุชุตุฏูุฑ ุงูุชุญูููุงุช
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item" href="{% url 'competitions:export_general_analytics_excel' %}">
                            <i class="fas fa-file-excel text-success me-2"></i>
                            ๐ ุชุตุฏูุฑ ุงูุชุญูููุงุช ุงูุนุงูุฉ ุงูุดุงููุฉ
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{% url 'competitions:export_participants_results_excel' %}">
                            <i class="fas fa-users text-primary me-2"></i>
                            ๐ฅ ุชุตุฏูุฑ ูุชุงุฆุฌ ุงููุดุงุฑููู (ุญุณุจ ุงููุณุชูู)
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{% url 'competitions:export_analytics_excel' %}">
                            <i class="fas fa-file-excel text-info me-2"></i>
                            ุชุตุฏูุฑ Excel ุฃุณุงุณู
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{% url 'competitions:export_analytics_pdf' %}">
                            <i class="fas fa-file-pdf text-danger me-2"></i>
                            ุชุตุฏูุฑ PDF
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item" href="#" onclick="exportToExcel()">
                            <i class="fas fa-table text-primary me-2"></i>
                            ุชุตุฏูุฑ ุฌุฏูู ุงููุณุชููุงุช
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" onclick="exportOperationsToExcel()">
                            <i class="fas fa-calculator text-warning me-2"></i>
                            ุชุตุฏูุฑ ุฌุฏูู ุงูุนูููุงุช
                        </a>
                    </li>
                </ul>
            </div>

            <a href="{% url 'competitions:start_competition' %}" class="btn btn-outline-primary me-3">
                ุจุฏุก ูุณุงุจูุฉ ุฌุฏูุฏุฉ
            </a>
            <a href="{% url 'competitions:history' %}" class="btn btn-outline-secondary me-3">
                ุณุฌู ุงููุณุงุจูุงุช
            </a>
            <a href="{% url 'competitions:export_results_excel' %}" class="btn btn-outline-info">
                ุชุตุฏูุฑ ูุชุงุฆุฌ ุงููุณุงุจูุงุช
            </a>
        </div>
    </div>
</div>

<!-- Chart.js and SheetJS for charts and Excel export -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }

    .card {
        border-radius: 15px;
        transition: transform 0.3s ease;
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .progress {
        border-radius: 10px;
    }

    .badge {
        border-radius: 20px;
    }

    .table th {
        border-top: none;
        font-weight: 600;
    }

    .chart-canvas {
        width: 100% !important;
        height: 100% !important;
    }
</style>

<script>
// Data from Django template
const gradeStatsData = [
    {% for grade in grade_stats %}
    {
        grade: "{{ grade.grade_display }}",
        participants: {{ grade.participant_count }},
        competitions: {{ grade.total_competitions }},
        successRate: {{ grade.success_rate }},
        avgTime: {{ grade.avg_response_time }},
        totalQuestions: {{ grade.total_questions }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

const operationsData = [
    {% for op in operations_analysis %}
    {
        operation: "{{ op.operation_name }}",
        questionsCount: {{ op.questions_count }},
        successRate: {{ op.success_rate }},
        avgTime: {{ op.avg_time }},
        strengths: [{% for strength in op.strengths %}"{{ strength }}"{% if not forloop.last %},{% endif %}{% endfor %}],
        weaknesses: [{% for weakness in op.weaknesses %}"{{ weakness }}"{% if not forloop.last %},{% endif %}{% endfor %}]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Chart instances
let participantsChart, successRateChart, responseTimeChart, competitionsChart;
let operationsChart, operationsPerformanceChart;

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeGradeCharts();
    initializeOperationsCharts();
    updateSummaryCards();
    loadDynamicChartData();
});

// Load dynamic chart data from API
async function loadDynamicChartData() {
    try {
        // Load grade statistics
        const gradeResponse = await fetch('{% url "competitions:get_chart_data" "grade_stats" %}');
        if (gradeResponse.ok) {
            const gradeData = await gradeResponse.json();
            updateGradeCharts(gradeData.data);
        }

        // Load operations statistics
        const operationsResponse = await fetch('{% url "competitions:get_chart_data" "operations_stats" %}');
        if (operationsResponse.ok) {
            const operationsData = await operationsResponse.json();
            updateOperationsCharts(operationsData.data);
        }

        // Load time trends
        const trendsResponse = await fetch('{% url "competitions:get_chart_data" "time_trends" %}');
        if (trendsResponse.ok) {
            const trendsData = await trendsResponse.json();
            // You can add a trends chart here if needed
        }
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงูุฑุณูู ุงูุจูุงููุฉ:', error);
    }
}

// Update grade charts with fresh data
function updateGradeCharts(data) {
    if (data && data.length > 0) {
        // Update participants chart
        if (participantsChart) {
            participantsChart.data.labels = data.map(item => item.grade);
            participantsChart.data.datasets[0].data = data.map(item => item.participants);
            participantsChart.update();
        }

        // Update success rate chart
        if (successRateChart) {
            successRateChart.data.labels = data.map(item => item.grade);
            successRateChart.data.datasets[0].data = data.map(item => item.successRate);
            successRateChart.update();
        }

        // Update response time chart
        if (responseTimeChart) {
            responseTimeChart.data.labels = data.map(item => item.grade);
            responseTimeChart.data.datasets[0].data = data.map(item => item.avgTime);
            responseTimeChart.update();
        }

        // Update competitions chart
        if (competitionsChart) {
            competitionsChart.data.labels = data.map(item => item.grade);
            competitionsChart.data.datasets[0].data = data.map(item => item.competitions);
            competitionsChart.update();
        }
    }
}

// Update operations charts with fresh data
function updateOperationsCharts(data) {
    if (data && data.length > 0) {
        // Update operations distribution chart
        if (operationsChart) {
            operationsChart.data.labels = data.map(item => item.operation);
            operationsChart.data.datasets[0].data = data.map(item => item.questionsCount);
            operationsChart.update();
        }

        // Update operations performance chart
        if (operationsPerformanceChart) {
            operationsPerformanceChart.data.labels = data.map(item => item.operation);
            operationsPerformanceChart.data.datasets[0].data = data.map(item => item.successRate);
            operationsPerformanceChart.data.datasets[1].data = data.map(item => item.avgTime);
            operationsPerformanceChart.update();
        }
    }
}

function updateSummaryCards() {
    // Calculate totals
    const totalParticipants = gradeStatsData.reduce((sum, grade) => sum + grade.participants, 0);
    const totalCompetitions = gradeStatsData.reduce((sum, grade) => sum + grade.competitions, 0);
    const avgSuccessRate = gradeStatsData.reduce((sum, grade) => sum + grade.successRate, 0) / gradeStatsData.length;

    // Update cards
    document.getElementById('totalParticipants').textContent = totalParticipants;
    document.getElementById('totalCompetitions').textContent = totalCompetitions;

    // Update average success rate if element exists
    const avgElement = document.querySelector('.card.bg-gradient-info h2');
    if (avgElement) {
        avgElement.textContent = avgSuccessRate.toFixed(1) + '%';
    }
}

function initializeGradeCharts() {
    // Participants Chart
    const participantsCtx = document.getElementById('participantsChart').getContext('2d');
    participantsChart = new Chart(participantsCtx, {
        type: 'bar',
        data: {
            labels: gradeStatsData.map(item => item.grade),
            datasets: [{
                label: 'ุนุฏุฏ ุงููุดุงุฑููู',
                data: gradeStatsData.map(item => item.participants),
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '๐ฅ ุนุฏุฏ ุงููุดุงุฑููู ุญุณุจ ุงููุณุชูู ุงูุฏุฑุงุณู'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'ุนุฏุฏ ุงููุดุงุฑููู'
                    }
                }
            }
        }
    });

    // Success Rate Chart
    const successRateCtx = document.getElementById('successRateChart').getContext('2d');
    successRateChart = new Chart(successRateCtx, {
        type: 'line',
        data: {
            labels: gradeStatsData.map(item => item.grade),
            datasets: [{
                label: 'ูุนุฏู ุงููุฌุงุญ (%)',
                data: gradeStatsData.map(item => item.successRate),
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'โ ูุนุฏู ุงููุฌุงุญ ุญุณุจ ุงููุณุชูู ุงูุฏุฑุงุณู'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'ูุนุฏู ุงููุฌุงุญ (%)'
                    }
                }
            }
        }
    });

    // Response Time Chart
    const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
    responseTimeChart = new Chart(responseTimeCtx, {
        type: 'bar',
        data: {
            labels: gradeStatsData.map(item => item.grade),
            datasets: [{
                label: 'ูุชูุณุท ููุช ุงูุฅุฌุงุจุฉ (ุซุงููุฉ)',
                data: gradeStatsData.map(item => item.avgTime),
                backgroundColor: 'rgba(255, 206, 86, 0.8)',
                borderColor: 'rgba(255, 206, 86, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'โฑ๏ธ ูุชูุณุท ููุช ุงูุฅุฌุงุจุฉ ุญุณุจ ุงููุณุชูู ุงูุฏุฑุงุณู'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'ุงูููุช (ุซุงููุฉ)'
                    }
                }
            }
        }
    });

    // Competitions Chart
    const competitionsCtx = document.getElementById('competitionsChart').getContext('2d');
    competitionsChart = new Chart(competitionsCtx, {
        type: 'doughnut',
        data: {
            labels: gradeStatsData.map(item => item.grade),
            datasets: [{
                label: 'ุฅุฌูุงูู ุงููุณุงุจูุงุช',
                data: gradeStatsData.map(item => item.competitions),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(199, 199, 199, 0.8)',
                    'rgba(83, 102, 255, 0.8)',
                    'rgba(255, 99, 255, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '๐ ุชูุฒูุน ุงููุณุงุจูุงุช ุญุณุจ ุงููุณุชูู ุงูุฏุฑุงุณู'
                }
            }
        }
    });
}

function initializeOperationsCharts() {
    // Operations Distribution Chart
    const operationsCtx = document.getElementById('operationsChart').getContext('2d');
    operationsChart = new Chart(operationsCtx, {
        type: 'pie',
        data: {
            labels: operationsData.map(item => item.operation),
            datasets: [{
                label: 'ุนุฏุฏ ุงูุฃุณุฆูุฉ',
                data: operationsData.map(item => item.questionsCount),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '๐งฎ ุชูุฒูุน ุงูุฃุณุฆูุฉ ุญุณุจ ุงูุนูููุฉ ุงูุญุณุงุจูุฉ'
                }
            }
        }
    });

    // Operations Performance Chart
    const operationsPerformanceCtx = document.getElementById('operationsPerformanceChart').getContext('2d');
    operationsPerformanceChart = new Chart(operationsPerformanceCtx, {
        type: 'bar',
        data: {
            labels: operationsData.map(item => item.operation),
            datasets: [{
                label: 'ูุนุฏู ุงููุฌุงุญ (%)',
                data: operationsData.map(item => item.successRate),
                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'ูุชูุณุท ุงูููุช (ุซุงููุฉ)',
                data: operationsData.map(item => item.avgTime),
                backgroundColor: 'rgba(255, 206, 86, 0.8)',
                borderColor: 'rgba(255, 206, 86, 1)',
                borderWidth: 1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: '๐ ุฃุฏุงุก ุงูุนูููุงุช ุงูุญุณุงุจูุฉ'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'ูุนุฏู ุงููุฌุงุญ (%)'
                    },
                    max: 100
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'ุงูููุช (ุซุงููุฉ)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    }
                }
            }
        }
    });
}

function showChart(chartId) {
    // Hide all charts
    document.querySelectorAll('.chart-canvas').forEach(canvas => {
        canvas.style.display = 'none';
    });

    // Show selected chart
    document.getElementById(chartId).style.display = 'block';

    // Update button states
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

// Excel Export Functions
function exportToExcel() {
    const wb = XLSX.utils.book_new();

    // Grade Statistics Sheet
    const gradeData = [
        ['ุงููุณุชูู ุงูุฏุฑุงุณู', 'ุนุฏุฏ ุงููุดุงุฑููู', 'ุฅุฌูุงูู ุงููุณุงุจูุงุช', 'ูุชูุณุท ููุช ุงูุฅุฌุงุจุฉ (ุซุงููุฉ)', 'ูุนุฏู ุงููุฌุงุญ (%)', 'ุฅุฌูุงูู ุงูุฃุณุฆูุฉ']
    ];

    gradeStatsData.forEach(grade => {
        gradeData.push([
            grade.grade,
            grade.participants,
            grade.competitions,
            grade.avgTime,
            grade.successRate,
            grade.totalQuestions
        ]);
    });

    const gradeWs = XLSX.utils.aoa_to_sheet(gradeData);
    XLSX.utils.book_append_sheet(wb, gradeWs, 'ุฅุญุตุงุฆูุงุช ุงููุณุชููุงุช');

    // Save file
    XLSX.writeFile(wb, 'ุชุญูููุงุช_ุงููุณุชููุงุช_ุงูุฏุฑุงุณูุฉ.xlsx');
}

function exportOperationsToExcel() {
    const wb = XLSX.utils.book_new();

    // Operations Statistics Sheet
    const operationsDataExcel = [
        ['ุงูุนูููุฉ', 'ุนุฏุฏ ุงูุฃุณุฆูุฉ', 'ูุนุฏู ุงููุฌุงุญ (%)', 'ูุชูุณุท ุงูููุช (ุซุงููุฉ)', 'ููุงุท ุงูููุฉ', 'ููุงุท ุงูุถุนู']
    ];

    operationsData.forEach(op => {
        operationsDataExcel.push([
            op.operation,
            op.questionsCount,
            op.successRate,
            op.avgTime,
            op.strengths.join(', '),
            op.weaknesses.join(', ')
        ]);
    });

    const operationsWs = XLSX.utils.aoa_to_sheet(operationsDataExcel);
    XLSX.utils.book_append_sheet(wb, operationsWs, 'ุชุญููู ุงูุนูููุงุช');

    // Save file
    XLSX.writeFile(wb, 'ุชุญูููุงุช_ุงูุนูููุงุช_ุงูุญุณุงุจูุฉ.xlsx');
}
</script>
{% endblock %}
