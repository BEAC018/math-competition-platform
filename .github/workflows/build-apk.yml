name: ğŸ“± Build Math Competition APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
        
    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git zip unzip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev \
          libtinfo5 cmake libffi-dev libssl-dev \
          build-essential ccache m4 libtool \
          libpng-dev libjpeg-dev libfreetype6-dev \
          libportmidi-dev libsdl2-dev libsdl2-image-dev \
          libsdl2-mixer-dev libsdl2-ttf-dev
          
    - name: ğŸ”§ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython kivy kivymd
        pip install -r requirements.txt
        
    - name: ğŸ“± Setup Android SDK
      run: |
        # Download Android command line tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
        unzip -q commandlinetools-linux-8512546_latest.zip
        
        # Setup Android SDK
        mkdir -p $HOME/android-sdk/cmdline-tools
        mv cmdline-tools $HOME/android-sdk/cmdline-tools/latest
        
        # Set environment variables
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH
        
    - name: ğŸ“‹ Accept Android licenses
      run: |
        yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses
        
    - name: ğŸ—ï¸ Build APK
      run: |
        # Initialize buildozer
        buildozer init
        
        # Build debug APK
        buildozer android debug
        
    - name: ğŸ“± Rename APK
      run: |
        # Find the generated APK and rename it
        find bin -name "*.apk" -exec cp {} math-competition-app.apk \;
        
    - name: ğŸ“Š APK Info
      run: |
        if [ -f "math-competition-app.apk" ]; then
          echo "âœ… APK built successfully!"
          echo "ğŸ“ File: math-competition-app.apk"
          echo "ğŸ“ Size: $(du -h math-competition-app.apk | cut -f1)"
          echo "ğŸ” Details:"
          file math-competition-app.apk
        else
          echo "âŒ APK build failed!"
          exit 1
        fi
        
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: math-competition-apk
        path: math-competition-app.apk
        retention-days: 30
        
    - name: ğŸ“ Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: math-competition-app.apk
        name: Math Competition App ${{ github.ref_name }}
        body: |
          ğŸ“± **ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ù„Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù†Ù‚Ø§Ù„**
          
          ğŸ¯ **Ø§Ù„Ù…ÙŠØ²Ø§Øª:**
          - âœ… Ù†ÙØ³ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ 100% - Ù„Ø§ ØªØºÙŠÙŠØ±
          - âœ… ÙˆØ§Ø¬Ù‡Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù‡Ø§ØªÙ
          - âœ… ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª
          - âœ… Ø®Ø§Ø¯Ù… Django Ù…Ø¯Ù…Ø¬
          - âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
          
          ğŸ“‹ **Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„:**
          - Android 5.0+ (API 21)
          - 100MB Ù…Ø³Ø§Ø­Ø© ÙØ§Ø±ØºØ©
          - Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¥Ù†ØªØ±Ù†Øª Ù„Ù„Ø¹Ù…Ù„
          
          ğŸš€ **Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª:**
          1. Ø­Ù…Ù„ Ù…Ù„Ù APK
          2. ÙØ¹Ù„ "Unknown Sources" ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Android
          3. Ø«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          4. Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª!
          
          ğŸ”‘ **Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„:**
          - Ø±Ù…Ø² Ø§Ù„Ø·Ù„Ø§Ø¨: ben25
          - Ø§Ù„Ù…Ø¯ÙŠØ±: admin / [Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªÙˆØ«ÙŠÙ‚]
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
