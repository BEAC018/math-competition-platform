{% extends 'base/base.html' %}
{% load static %}

{% block title %}ุจุฏุก ูุณุงุจูุฉ ุฌุฏูุฏุฉ - ููุตุฉ ุงูุญุณุงุจ ููุฑูุงุถูุงุช{% endblock %}

{% block extra_css %}
<style>
    .bg-purple {
        background-color: #6f42c1 !important;
    }

    .participant-card {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        border: 1px solid transparent;
        min-height: 100px;
        border-radius: 8px;
        max-width: 100%;
    }

    .participant-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.12) !important;
        border-color: #007bff !important;
    }

    .participant-card.selected {
        border-color: #28a745 !important;
        background-color: #f8fff9 !important;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2) !important;
    }

    .participant-name {
        font-size: 0.85rem;
        font-weight: 600;
        line-height: 1.2;
        margin-bottom: 0.25rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .participant-info {
        font-size: 0.7rem;
        color: #6c757d;
        line-height: 1;
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .bg-gradient-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .text-shadow {
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    /* ุชุญุณููุงุช ููุดุงุดุงุช ุงูุตุบูุฑุฉ */
    @media (max-width: 576px) {
        .participant-card {
            min-height: 90px;
        }

        .participant-name {
            font-size: 0.75rem;
        }

        .participant-info {
            font-size: 0.65rem;
        }
    }

    /* ุชุญุณููุงุช ููุดุงุดุงุช ุงููุชูุณุทุฉ */
    @media (min-width: 768px) and (max-width: 991px) {
        .participant-card {
            min-height: 95px;
        }
    }

    /* ุชุญุณููุงุช ููุดุงุดุงุช ุงููุจูุฑุฉ */
    @media (min-width: 1200px) {
        .participant-card {
            min-height: 105px;
        }
    }

    /* ุชุญุณูู ุชูุฒูุน ุงูุดุจูุฉ */
    #participantsGrid {
        max-height: 400px;
        overflow-y: auto;
    }

    #participantsGrid::-webkit-scrollbar {
        width: 6px;
    }

    #participantsGrid::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    #participantsGrid::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

    #participantsGrid::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* ุชุญุณููุงุช ุงูุจุญุซ */
    #participantSearchInput {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        font-size: 0.95rem;
    }

    #participantSearchInput:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    #clearSearchBtn {
        border-radius: 0 8px 8px 0;
        border: 2px solid #e9ecef;
        border-left: none;
    }

    .input-group-text {
        border-radius: 8px 0 0 8px;
        border: 2px solid #e9ecef;
        border-right: none;
        background-color: #f8f9fa;
    }

    /* ุชุญุณูู ุนุฏุงุฏ ุงููุดุงุฑููู */
    #participantsCounter {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 6px;
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        display: inline-block;
    }

    /* ุชุญุณูู ุฑุณุงูุฉ ุนุฏู ูุฌูุฏ ูุชุงุฆุฌ */
    #noSearchResults {
        border-radius: 8px;
        border-left: 4px solid #ffc107;
        background-color: #fff3cd;
    }

    /* ุชุญุณูู ุนุฑุถ ุงูุฃุณูุงุก ูู ุงูุจุทุงูุงุช */
    .participant-name {
        min-height: 60px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
        white-space: normal;
    }

    .participant-card {
        min-height: 120px;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }

    .participant-card:hover {
        border-color: #007bff;
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-0">
    <div class="col-12">
        <div class="card shadow-lg border-0 rounded-lg mt-4">
            <div class="card-header bg-gradient-primary text-white text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-rocket fa-3x text-shadow"></i>
                </div>
                <h2 class="my-2 text-shadow">๐ ุจุฏุก ูุณุงุจูุฉ ุฌุฏูุฏุฉ</h2>
                <p class="mb-0">ุงุฎุชุฑ ุงููุดุงุฑู ููุณุชูู ุงูุตุนูุจุฉ ูุงุจุฏุฃ ุงูุชุญุฏู!</p>
            </div>
            <div class="card-body">
                <!-- ุฒุฑ ุฅุถุงูุฉ ูุดุงุฑู ุฌุฏูุฏ - ุจุงุฑุฒ ููุงุถุญ -->
                <div class="text-center mb-4">
                    <button type="button" class="btn btn-success btn-lg mb-3" data-bs-toggle="modal" data-bs-target="#newAddParticipantModal">
                        <i class="fas fa-user-plus me-2"></i>
                        โ ุฅุถุงูุฉ ูุดุงุฑู ุฌุฏูุฏ
                    </button>
                    <p class="lead">ุงุจุฏุฃ ูุณุงุจูุฉ ุฑูุงุถูุฉ ุฌุฏูุฏุฉ</p>
                </div>

                <form method="post" action="{% url 'competitions:start_competition' %}" id="competition-form">
                    {% csrf_token %}

                    <!-- ุงููุธุงู ุงููุฑูู ุงูุฌุฏูุฏ ูุงุฎุชูุงุฑ ุงููุดุงุฑููู -->

                    <!-- ุงููุฑุญูุฉ ุงูุฃููู: ุงุฎุชูุงุฑ ุงููุณุชูู ุงูุฏุฑุงุณู -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-graduation-cap me-2"></i>
                                ๐ฏ ุงููุฑุญูุฉ ุงูุฃููู: ุงุฎุชูุงุฑ ุงููุณุชูู ุงูุฏุฑุงุณู
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="gradeFilter" class="form-label">
                                    <i class="fas fa-school me-1"></i>
                                    ุงููุณุชูู ุงูุฏุฑุงุณู
                                </label>
                                <select class="form-select form-select-lg" id="gradeFilter" name="grade_filter" required>
                                    <option value="">-- ุงุฎุชุฑ ุงููุณุชูู ุงูุฏุฑุงุณู ุฃููุงู --</option>
                                    {% for grade_value, grade_stats in grade_stats.items %}
                                        <option value="{{ grade_value }}" {% if current_grade == grade_value|stringformat:"s" %}selected{% endif %}>
                                            {% if grade_value == 1 %}๐{% elif grade_value == 2 %}๐{% elif grade_value == 3 %}๐{% elif grade_value == 4 %}๐{% elif grade_value == 5 %}๐{% elif grade_value == 6 %}๐{% elif grade_value == 7 %}๐ซ{% elif grade_value == 8 %}๐ฏ{% elif grade_value == 9 %}๐{% endif %}
                                            {{ grade_stats.display }} ({{ grade_stats.count }} ูุดุงุฑู)
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    ๐ ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุณุชูู ุงูุฏุฑุงุณู ุฃููุงู ูุนุฑุถ ุงููุดุงุฑููู
                                </div>
                            </div>

                            <!-- ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ -->
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="h5 text-primary mb-1" id="totalParticipants">
                                        {{ total_participants|default:0 }}
                                    </div>
                                    <small class="text-muted">ุฅุฌูุงูู ุงููุดุงุฑููู</small>
                                </div>
                                <div class="col-4">
                                    <div class="h5 text-success mb-1">{{ grade_stats|length }}</div>
                                    <small class="text-muted">ูุณุชูู ูุชุงุญ</small>
                                </div>
                                <div class="col-4">
                                    <div class="h5 text-info mb-1">9</div>
                                    <small class="text-muted">ูุณุชูู ูุงูู</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ุงููุฑุญูุฉ ุงูุซุงููุฉ: ุงุฎุชูุงุฑ ุงููุดุงุฑู -->
                    <div class="card mb-4" id="participantSelectionCard" style="display: none;">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-user me-2"></i>
                                ๐ค ุงููุฑุญูุฉ ุงูุซุงููุฉ: ุงุฎุชูุงุฑ ุงููุดุงุฑู
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="participantsLoadingMessage" class="text-center py-3" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                ุฌุงุฑู ุชุญููู ุงููุดุงุฑููู...
                            </div>

                            <div id="noParticipantsMessage" class="alert alert-warning" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ูุง ููุฌุฏ ูุดุงุฑููู ูู ูุฐุง ุงููุณุชูู ุงูุฏุฑุงุณู.
                                <button type="button" class="btn btn-sm btn-success ms-2" data-bs-toggle="modal" data-bs-target="#newAddParticipantModal">
                                    ุฅุถุงูุฉ ูุดุงุฑู ุฌุฏูุฏ
                                </button>
                            </div>

                            <!-- ูุฑุจุน ุงูุจุญุซ -->
                            <div id="participantSearchContainer" class="mb-3" style="display: none;">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="participantSearchInput" placeholder="๐ ุงุจุญุซ ุนู ุงููุดุงุฑู ุจุงูุงุณู..." autocomplete="off">
                                    <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn" onclick="clearParticipantSearch()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    ๐ก ุงูุชุจ ุฌุฒุก ูู ุงูุงุณู ููุจุญุซ ุงูุณุฑูุน
                                </div>
                            </div>

                            <!-- ูุนูููุงุช ุงููุดุงุฑููู -->
                            <div class="mb-2" id="participantsInfo" style="display: none;">
                                <div class="alert alert-info py-2 mb-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <small>ุงููุดุงุฑููู ููุฒุนูู ุนูู 4 ุฃุณุทุฑ ูุณูููุฉ ุงูุงุฎุชูุงุฑ. ุงุณุชุฎุฏู ุงูุจุญุซ ููุนุซูุฑ ุนูู ูุดุงุฑู ูุญุฏุฏ.</small>
                                </div>
                            </div>

                            <!-- ุนุฏุงุฏ ุงููุชุงุฆุฌ -->
                            <div id="participantsCounter" class="mb-2" style="display: none;">
                                <small class="text-muted">
                                    <i class="fas fa-users me-1"></i>
                                    ุนุฏุฏ ุงููุดุงุฑููู: <span id="participantsCount">0</span>
                                </small>
                            </div>

                            <!-- ุดุจูุฉ ุงููุดุงุฑููู -->
                            <div id="participantsGrid" class="row g-2" style="display: none;">
                                <!-- ุณูุชู ุชุญููู ุงููุดุงุฑููู ููุง ุนุจุฑ AJAX -->
                            </div>

                            <!-- ุฑุณุงูุฉ ุนุฏู ูุฌูุฏ ูุชุงุฆุฌ ุจุญุซ -->
                            <div id="noSearchResults" class="alert alert-warning" style="display: none;">
                                <i class="fas fa-search me-2"></i>
                                ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุจุญุซ "<span id="searchTerm"></span>". ุฌุฑุจ ูููุงุช ุฃุฎุฑู ุฃู ุงูุณุญ ุงูุจุญุซ ูุนุฑุถ ุฌููุน ุงููุดุงุฑููู.
                            </div>

                            <!-- ุนุฑุถ ุงููุดุงุฑู ุงููุฎุชุงุฑ -->
                            <div id="selectedParticipantDisplay" class="alert alert-info mt-3" style="display: none;">
                                <i class="fas fa-user-check me-2"></i>
                                <span id="selectedParticipantText"></span>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearParticipantSelection()">
                                    ุชุบููุฑ ุงูุงุฎุชูุงุฑ
                                </button>
                            </div>

                            <!-- ุญูู ูุฎูู ูููุดุงุฑู ุงููุฎุชุงุฑ -->
                            <input type="hidden" name="participant_name" id="participant_id" required>

                            <div class="form-text mt-2">
                                <i class="fas fa-lightbulb me-1"></i>
                                ๐ก ูุตูุญุฉ: ุงููุฑ ุนูู ุจุทุงูุฉ ุงููุดุงุฑู ูุงุฎุชูุงุฑู
                            </div>

                            <!-- ุฃุฏูุงุช ุฅุฏุงุฑุฉ ุงููุดุงุฑููู -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#manageParticipantsModal">
                                        <i class="fas fa-cog me-2"></i> ุฅุฏุงุฑุฉ ุงููุดุงุฑููู
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-success w-100" onclick="refreshParticipants()">
                                        <i class="fas fa-sync-alt me-2"></i> ๐ ุชุญุฏูุซ ุงููุงุฆูุฉ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ุงููุฑุญูุฉ ุงูุซุงูุซุฉ: ุงุฎุชูุงุฑ ูุณุชูู ุงูุตุนูุจุฉ -->
                    <div class="card mb-4" id="difficultySelectionCard" style="display: none;">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-star me-2"></i>
                                ๐ฏ ุงููุฑุญูุฉ ุงูุซุงูุซุฉ: ุงุฎุชูุงุฑ ูุณุชูู ุงูุตุนูุจุฉ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="form-text mb-3">
                                <i class="fas fa-info-circle me-1"></i>
                                ุงุฎุชุฑ ูุณุชูู ุงูุตุนูุจุฉ ุงูููุงุณุจ ูููุดุงุฑู ุงููุญุฏุฏ
                            </div>
                        </div>
                    </div>

                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <!-- ุงููุฑุญูุฉ ุงูุฃููู - ุงููุณุชููุงุช ุงูุฃุณุงุณูุฉ -->
                            <div class="card border-primary mb-4">
                                <div class="card-header bg-gradient-primary text-white">
                                    <h4 class="mb-0">
                                        <i class="fas fa-graduation-cap me-2"></i>
                                        ๐ ุงููุฑุญูุฉ ุงูุฃููู - ุงููุณุชููุงุช ุงูุฃุณุงุณูุฉ
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="form-check card border-0 shadow-sm p-3 mb-3">
                                        <input class="form-check-input" type="radio" name="difficulty" id="difficulty1" value="1" checked>
                                        <label class="form-check-label d-flex justify-content-between align-items-center" for="difficulty1">
                                            <div>
                                                <h5 class="mb-1">๐ข ุงููุณุชูู ุงูุฃูู</h5>
                                                <small class="text-muted">โ ุฌูุน (8) + โ ุทุฑุญ (7) | ุฃุนุฏุงุฏ 1-10 | โฑ๏ธ 15 ุซุงููุฉ/ุณุคุงู</small>
                                            </div>
                                            <span class="badge bg-success rounded-pill">๐ข ุณูู</span>
                                        </label>
                                    </div>

                                    <div class="form-check card border-0 shadow-sm p-3 mb-3">
                                        <input class="form-check-input" type="radio" name="difficulty" id="difficulty2" value="2">
                                        <label class="form-check-label d-flex justify-content-between align-items-center" for="difficulty2">
                                            <div>
                                                <h5 class="mb-1">๐ต ุงููุณุชูู ุงูุซุงูู</h5>
                                                <small class="text-muted">โ ุฌูุน (5) + โ ุทุฑุญ (5) + โ๏ธ ุถุฑุจ (5) | ุฃุนุฏุงุฏ 3-20 | โฑ๏ธ 15 ุซุงููุฉ/ุณุคุงู</small>
                                            </div>
                                            <span class="badge bg-info rounded-pill">๐ต ูุชูุณุท</span>
                                        </label>
                                    </div>

                                    <div class="form-check card border-0 shadow-sm p-3 mb-3">
                                        <input class="form-check-input" type="radio" name="difficulty" id="difficulty3" value="3">
                                        <label class="form-check-label d-flex justify-content-between align-items-center" for="difficulty3">
                                            <div>
                                                <h5 class="mb-1">ุงููุณุชูู ุงูุซุงูุซ</h5>
                                                <small class="text-muted">ุฌูุน (4) + ุทุฑุญ (4) + ุถุฑุจ (5) + ูุณูุฉ (2) | ุฃุนุฏุงุฏ 5-30 | 15 ุซุงููุฉ/ุณุคุงู</small>
                                            </div>
                                            <span class="badge bg-warning rounded-pill">ูุชูุณุท+</span>
                                        </label>
                                    </div>

                                    <div class="form-check card border-0 shadow-sm p-3 mb-3">
                                        <input class="form-check-input" type="radio" name="difficulty" id="difficulty4" value="4">
                                        <label class="form-check-label d-flex justify-content-between align-items-center" for="difficulty4">
                                            <div>
                                                <h5 class="mb-1">ุงููุณุชูู ุงูุฑุงุจุน</h5>
                                                <small class="text-muted">ุฌูุน (4) + ุทุฑุญ (4) + ุถุฑุจ (5) + ูุณูุฉ (2) | ุฃุนุฏุงุฏ 9-40 | 15 ุซุงููุฉ/ุณุคุงู</small>
                                            </div>
                                            <span class="badge bg-danger rounded-pill">ุตุนุจ</span>
                                        </label>
                                    </div>

                                    <div class="form-check card border-0 shadow-sm p-3 mb-3">
                                        <input class="form-check-input" type="radio" name="difficulty" id="difficulty5" value="5">
                                        <label class="form-check-label d-flex justify-content-between align-items-center" for="difficulty5">
                                            <div>
                                                <h5 class="mb-1">ุงููุณุชูู ุงูุฎุงูุณ</h5>
                                                <small class="text-muted">ุฌูุน (4) + ุทุฑุญ (4) + ุถุฑุจ (5) + ูุณูุฉ (2) | ุฃุนุฏุงุฏ 21-99 | 10 ุซูุงูู/ุณุคุงู</small>
                                            </div>
                                            <span class="badge bg-dark rounded-pill">ุตุนุจ+</span>
                                        </label>
                                    </div>

                                    <div class="form-check card border-0 shadow-sm p-3 mb-3">
                                        <input class="form-check-input" type="radio" name="difficulty" id="difficulty6" value="6">
                                        <label class="form-check-label d-flex justify-content-between align-items-center" for="difficulty6">
                                            <div>
                                                <h5 class="mb-1">ุงููุณุชูู ุงูุณุงุฏุณ</h5>
                                                <small class="text-muted">ุฌูุน (4) + ุทุฑุญ (4) + ุถุฑุจ (4) + ูุณูุฉ (3) | ุฃุนุฏุงุฏ 25-99 | 10 ุซูุงูู/ุณุคุงู</small>
                                            </div>
                                            <span class="badge bg-dark rounded-pill">ูุชูุฏู</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- ุงููุฑุญูุฉ ุงูุซุงููุฉ - ุงููุณุชููุงุช ุงููุชูุฏูุฉ -->
                            <div class="card border-warning mb-4">
                                <div class="card-header bg-gradient-warning text-white">
                                    <h4 class="mb-0">
                                        <i class="fas fa-star me-2"></i>
                                        ๐ ุงููุฑุญูุฉ ุงูุซุงููุฉ - ุงููุณุชููุงุช ุงููุชูุฏูุฉ
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="form-check card border-0 shadow-sm p-3 mb-3">
                                        <input class="form-check-input" type="radio" name="difficulty" id="difficulty7" value="7">
                                        <label class="form-check-label d-flex justify-content-between align-items-center" for="difficulty7">
                                            <div>
                                                <h5 class="mb-1">ุงููุณุชูู ุงูุฃูู - ุงููุฑุญูุฉ ุงูุซุงููุฉ</h5>
                                                <small class="text-muted">ุฃุนุฏุงุฏ ุตุญูุญุฉ ููุฌุจุฉ ูุณุงูุจุฉ + ุฃููููุฉ ุงูุนูููุงุช + ูุณุงุฆู ุชุทุจูููุฉ | 10 ุซูุงูู/ุณุคุงู</small>
                                            </div>
                                            <span class="badge bg-purple rounded-pill">ูุชูุฏู</span>
                                        </label>
                                    </div>

                                    <div class="form-check card border-0 shadow-sm p-3 mb-3">
                                        <input class="form-check-input" type="radio" name="difficulty" id="difficulty8" value="8">
                                        <label class="form-check-label d-flex justify-content-between align-items-center" for="difficulty8">
                                            <div>
                                                <h5 class="mb-1">ุงููุณุชูู ุงูุซุงูู - ุงููุฑุญูุฉ ุงูุซุงููุฉ</h5>
                                                <small class="text-muted">ูุณูุฑ ูุฃุนุฏุงุฏ ุนุดุฑูุฉ + ุชุนุงุจูุฑ ุฌุจุฑูุฉ + ูุณุงุฆู ุชุทุจูููุฉ | 10 ุซูุงูู/ุณุคุงู</small>
                                            </div>
                                            <span class="badge bg-purple rounded-pill">ูุชูุฏู+</span>
                                        </label>
                                    </div>

                                    <div class="form-check card border-0 shadow-sm p-3 mb-3">
                                        <input class="form-check-input" type="radio" name="difficulty" id="difficulty9" value="9">
                                        <label class="form-check-label d-flex justify-content-between align-items-center" for="difficulty9">
                                            <div>
                                                <h5 class="mb-1">ุงููุณุชูู ุงูุซุงูุซ - ุงููุฑุญูุฉ ุงูุซุงููุฉ</h5>
                                                <small class="text-muted">ูุนุงุฏูุงุช + ููุฏุณุฉ + ูุซูุซุงุช + ูุณุงุฆู ุชุทุจูููุฉ | 10 ุซูุงูู/ุณุคุงู</small>
                                            </div>
                                            <span class="badge bg-purple rounded-pill">ุฎุจูุฑ</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <div class="row text-center">
                            <div class="col-12">
                                <h5 class="mb-3">ุชูุฒูุน ุงูุฃุณุฆูุฉ ุญุณุจ ุงููุณุชูู</h5>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>ุงููุณุชูู</th>
                                        <th>ุฌูุน</th>
                                        <th>ุทุฑุญ</th>
                                        <th>ุถุฑุจ</th>
                                        <th>ูุณูุฉ</th>
                                        <th>ุฃุฎุฑู</th>
                                        <th>ุงููุฌููุน</th>
                                        <th>ุงูููุช/ุณุคุงู</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="table-primary">
                                        <td colspan="8" class="text-center fw-bold">ุงููุฑุญูุฉ ุงูุฃููู - ุงููุณุชููุงุช ุงูุฃุณุงุณูุฉ</td>
                                    </tr>
                                    <tr>
                                        <td>ุงููุณุชูู ุงูุฃูู</td>
                                        <td>8</td>
                                        <td>7</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>15</td>
                                        <td>15 ุซุงููุฉ</td>
                                    </tr>
                                    <tr>
                                        <td>ุงููุณุชูู ุงูุซุงูู</td>
                                        <td>5</td>
                                        <td>5</td>
                                        <td>5</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>15</td>
                                        <td>15 ุซุงููุฉ</td>
                                    </tr>
                                    <tr>
                                        <td>ุงููุณุชูู ุงูุซุงูุซ</td>
                                        <td>4</td>
                                        <td>4</td>
                                        <td>5</td>
                                        <td>2</td>
                                        <td>0</td>
                                        <td>15</td>
                                        <td>15 ุซุงููุฉ</td>
                                    </tr>
                                    <tr>
                                        <td>ุงููุณุชูู ุงูุฑุงุจุน</td>
                                        <td>4</td>
                                        <td>4</td>
                                        <td>5</td>
                                        <td>2</td>
                                        <td>0</td>
                                        <td>15</td>
                                        <td>15 ุซุงููุฉ</td>
                                    </tr>
                                    <tr>
                                        <td>ุงููุณุชูู ุงูุฎุงูุณ</td>
                                        <td>4</td>
                                        <td>4</td>
                                        <td>5</td>
                                        <td>2</td>
                                        <td>0</td>
                                        <td>15</td>
                                        <td>10 ุซูุงูู</td>
                                    </tr>
                                    <tr>
                                        <td>ุงููุณุชูู ุงูุณุงุฏุณ</td>
                                        <td>4</td>
                                        <td>4</td>
                                        <td>4</td>
                                        <td>3</td>
                                        <td>0</td>
                                        <td>15</td>
                                        <td>10 ุซูุงูู</td>
                                    </tr>
                                    <tr class="table-secondary">
                                        <td colspan="8" class="text-center fw-bold">ุงููุฑุญูุฉ ุงูุซุงููุฉ - ุงููุณุชููุงุช ุงููุชูุฏูุฉ</td>
                                    </tr>
                                    <tr>
                                        <td>ุงููุณุชูู ุงูุฃูู - ุงููุฑุญูุฉ 2</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>15</td>
                                        <td>15</td>
                                        <td>10 ุซูุงูู</td>
                                    </tr>
                                    <tr>
                                        <td>ุงููุณุชูู ุงูุซุงูู - ุงููุฑุญูุฉ 2</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>15</td>
                                        <td>15</td>
                                        <td>10 ุซูุงูู</td>
                                    </tr>
                                    <tr>
                                        <td>ุงููุณุชูู ุงูุซุงูุซ - ุงููุฑุญูุฉ 2</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>0</td>
                                        <td>15</td>
                                        <td>15</td>
                                        <td>10 ุซูุงูู</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="small text-muted">
                            <strong>ููุงุญุธุฉ:</strong> "ุฃุฎุฑู" ุชุดูู: ุนูููุงุช ูุฎุชูุทุฉุ ูุณูุฑ ูุฃุนุฏุงุฏ ุนุดุฑูุฉุ ุฌุจุฑุ ููุฏุณุฉุ ูุซูุซุงุชุ ููุณุงุฆู ุชุทุจูููุฉ
                        </div>
                    </div>

                    <!-- ุฒุฑ ุจุฏุก ุงููุณุงุจูุฉ -->
                    <div class="text-center mt-4" id="startCompetitionSection" style="display: none;">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            ุฌููุน ุงูุฎุทูุงุช ููุชููุฉ! ููููู ุงูุขู ุจุฏุก ุงููุณุงุจูุฉ
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg px-5" id="start-competition-btn">
                            <i class="fas fa-rocket me-2"></i>
                            ๐ ุงุจุฏุฃ ุงููุณุงุจูุฉ
                        </button>
                    </div>
                </form>
            </div>

            <!-- Add Participant Modal -->
            <div class="modal fade" id="addParticipantModal" tabindex="-1" aria-labelledby="addParticipantModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addParticipantModalLabel">ุฅุถุงูุฉ ูุดุงุฑู ุฌุฏูุฏ</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ุฅุบูุงู"></button>
                        </div>
                        <div class="modal-body">
                            <form id="participantForm" method="post" action="{% url 'competitions:add_participant' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <ul class="nav nav-tabs mb-3" id="participantTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single" type="button" role="tab" aria-controls="single" aria-selected="true">ุฅุถุงูุฉ ูุดุงุฑู ูุงุญุฏ</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="excel-tab" data-bs-toggle="tab" data-bs-target="#excel" type="button" role="tab" aria-controls="excel" aria-selected="false">ุงุณุชูุฑุงุฏ ูู ููู Excel</button>
                                    </li>
                                </ul>

                                <div class="tab-content" id="participantTabsContent">
                                    <!-- Single Participant Tab -->
                                    <div class="tab-pane fade show active" id="single" role="tabpanel" aria-labelledby="single-tab">
                                        <div class="mb-3">
                                            <label for="new_participant_name" class="form-label">ุงูุงุณู ุงููุงูู</label>
                                            <input type="text" class="form-control" id="new_participant_name" name="participant_name">
                                        </div>
                                        <div class="mb-3">
                                            <label for="grade" class="form-label">ุงูุตู</label>
                                            <select class="form-select" id="grade" name="grade">
                                                <option value="" selected disabled>-- ุงุฎุชุฑ ุงูุตู --</option>
                                                <option value="1">ุงูุฃูู ุงุจุชุฏุงุฆู</option>
                                                <option value="2">ุงูุซุงูู ุงุจุชุฏุงุฆู</option>
                                                <option value="3">ุงูุซุงูุซ ุงุจุชุฏุงุฆู</option>
                                                <option value="4">ุงูุฑุงุจุน ุงุจุชุฏุงุฆู</option>
                                                <option value="5">ุงูุฎุงูุณ ุงุจุชุฏุงุฆู</option>
                                                <option value="6">ุงูุณุงุฏุณ ุงุจุชุฏุงุฆู</option>
                                                <option value="7">ุงูุฃูู ุฅุนุฏุงุฏู</option>
                                                <option value="8">ุงูุซุงูู ุฅุนุฏุงุฏู</option>
                                                <option value="9">ุงูุซุงูุซ ุฅุนุฏุงุฏู</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="group" class="form-label">ุงูููุฌ</label>
                                            <select class="form-select" id="group" name="group">
                                                <option value="1">ุงูููุฌ ุงูุฃูู</option>
                                                <option value="2">ุงูููุฌ ุงูุซุงูู</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Excel File Upload Tab -->
                                    <div class="tab-pane fade" id="excel" role="tabpanel" aria-labelledby="excel-tab">
                                        <div class="mb-3">
                                            <label for="participant_file" class="form-label">ููู Excel ุฃู CSV</label>
                                            <input type="file" class="form-control" id="participant_file" name="participant_file" accept=".xlsx,.csv">
                                        </div>
                                        <div class="alert alert-info">
                                            <h6>ุชูุณูู ุงูููู ุงููุทููุจ:</h6>
                                            <ul>
                                                <li>ูุฌุจ ุฃู ูุญุชูู ุงูููู ุนูู ุงูุฃุนูุฏุฉ ุงูุชุงููุฉ: <code>name</code> ู <code>grade</code> ู <code>group</code> (ุงุฎุชูุงุฑู)</li>
                                                <li><code>name</code>: ุงุณู ุงููุดุงุฑู</li>
                                                <li><code>grade</code>: ุฑูู ุงูุตู (1-9)</li>
                                                <li><code>group</code>: ุฑูู ุงูููุฌ (1 ุฃู 2) - ุงุฎุชูุงุฑูุ ุงูุงูุชุฑุงุถู ูู 1</li>
                                            </ul>
                                            <p>ูููู ุชุญููู <a href="#" onclick="downloadSampleFile()">ูููุฐุฌ</a> ููููู ุงููุทููุจ.</p>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                            <button type="submit" form="participantForm" class="btn btn-primary">ุฅุถุงูุฉ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุงููุงูุฐุฉ ุงูุฌุฏูุฏุฉ ุงููุญุณูุฉ ูุฅุถุงูุฉ ุงููุดุงุฑููู -->
            <div class="modal fade" id="newAddParticipantModal" tabindex="-1" aria-labelledby="newAddParticipantModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="newAddParticipantModalLabel">
                                <i class="fas fa-user-plus me-2"></i>
                                โ ุฅุถุงูุฉ ูุดุงุฑู ุฌุฏูุฏ
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ุฅุบูุงู"></button>
                        </div>
                        <div class="modal-body">
                            <!-- ุชุจููุจุงุช ููุงุฎุชูุงุฑ ุจูู ุงูุฅุถุงูุฉ ุงููุฑุฏูุฉ ูุงูุฌูุงุนูุฉ -->
                            <ul class="nav nav-pills nav-justified mb-4" id="addParticipantTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="single-participant-tab" data-bs-toggle="pill" data-bs-target="#single-participant" type="button" role="tab">
                                        <i class="fas fa-user me-2"></i>
                                        ๐ค ูุดุงุฑู ูุงุญุฏ
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="multiple-participants-tab" data-bs-toggle="pill" data-bs-target="#multiple-participants" type="button" role="tab">
                                        <i class="fas fa-users me-2"></i>
                                        ๐ฅ ุนุฏุฉ ูุดุงุฑููู
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="addParticipantTabsContent">
                                <!-- ุชุจููุจ ุงูุฅุถุงูุฉ ุงููุฑุฏูุฉ -->
                                <div class="tab-pane fade show active" id="single-participant" role="tabpanel">
                                    <form id="singleParticipantForm" method="post" action="{% url 'competitions:add_participant' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="add_type" value="single">

                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label for="single_name" class="form-label">
                                                    <i class="fas fa-signature me-1"></i>
                                                    ุงูุงุณู ุงููุงูู
                                                </label>
                                                <input type="text" class="form-control form-control-lg" id="single_name" name="name" required placeholder="ุฃุฏุฎู ุงูุงุณู ุงููุงูู ูููุดุงุฑู">
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="single_grade" class="form-label">
                                                    <i class="fas fa-graduation-cap me-1"></i>
                                                    ุงูุตู ุงูุฏุฑุงุณู
                                                </label>
                                                <select class="form-select form-select-lg" id="single_grade" name="grade" required>
                                                    <option value="">-- ุงุฎุชุฑ ุงูุตู --</option>
                                                    <option value="1">๐ ุงูุฃูู ุงุจุชุฏุงุฆู</option>
                                                    <option value="2">๐ ุงูุซุงูู ุงุจุชุฏุงุฆู</option>
                                                    <option value="3">๐ ุงูุซุงูุซ ุงุจุชุฏุงุฆู</option>
                                                    <option value="4">๐ ุงูุฑุงุจุน ุงุจุชุฏุงุฆู</option>
                                                    <option value="5">๐ ุงูุฎุงูุณ ุงุจุชุฏุงุฆู</option>
                                                    <option value="6">๐ ุงูุณุงุฏุณ ุงุจุชุฏุงุฆู</option>
                                                    <option value="7">๐ซ ุงูุฃูู ุฅุนุฏุงุฏู</option>
                                                    <option value="8">๐ฏ ุงูุซุงูู ุฅุนุฏุงุฏู</option>
                                                    <option value="9">๐ ุงูุซุงูุซ ุฅุนุฏุงุฏู</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="single_group" class="form-label">
                                                    <i class="fas fa-layer-group me-1"></i>
                                                    ุงูููุฌ
                                                </label>
                                                <select class="form-select form-select-lg" id="single_group" name="group" required>
                                                    <option value="1">๐ฅ ุงูููุฌ ุงูุฃูู</option>
                                                    <option value="2">๐ฅ ุงูููุฌ ุงูุซุงูู</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-success btn-lg">
                                                <i class="fas fa-plus-circle me-2"></i>
                                                โ ุฅุถุงูุฉ ุงููุดุงุฑู
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- ุชุจููุจ ุงูุฅุถุงูุฉ ุงูุฌูุงุนูุฉ -->
                                <div class="tab-pane fade" id="multiple-participants" role="tabpanel">
                                    <form id="multipleParticipantsForm" method="post" action="{% url 'competitions:add_participant' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="add_type" value="multiple">

                                        <div class="mb-3">
                                            <label for="participants_text" class="form-label">
                                                <i class="fas fa-list me-1"></i>
                                                ุฃุณูุงุก ุงููุดุงุฑููู
                                            </label>
                                            <textarea class="form-control" id="participants_text" name="participants_text" rows="6" required placeholder="ุฃุฏุฎู ุฃุณูุงุก ุงููุดุงุฑูููุ ูู ุงุณู ูู ุณุทุฑ ูููุตู:

ุฃุญูุฏ ูุญูุฏ ุนูู
ูุงุทูุฉ ุฃุญูุฏ ุญุณู
ูุญูุฏ ุนุจุฏุงููู ุณุงูู
..."></textarea>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                ุฃุฏุฎู ูู ุงุณู ูู ุณุทุฑ ูููุตู. ููููู ุฅุถุงูุฉ ุนุฏุฏ ุบูุฑ ูุญุฏูุฏ ูู ุงููุดุงุฑููู.
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="bulk_grade" class="form-label">
                                                    <i class="fas fa-graduation-cap me-1"></i>
                                                    ุงูุตู ุงูุฏุฑุงุณู (ููุฌููุน)
                                                </label>
                                                <select class="form-select form-select-lg" id="bulk_grade" name="bulk_grade" required>
                                                    <option value="">-- ุงุฎุชุฑ ุงูุตู --</option>
                                                    <option value="1">๐ ุงูุฃูู ุงุจุชุฏุงุฆู</option>
                                                    <option value="2">๐ ุงูุซุงูู ุงุจุชุฏุงุฆู</option>
                                                    <option value="3">๐ ุงูุซุงูุซ ุงุจุชุฏุงุฆู</option>
                                                    <option value="4">๐ ุงูุฑุงุจุน ุงุจุชุฏุงุฆู</option>
                                                    <option value="5">๐ ุงูุฎุงูุณ ุงุจุชุฏุงุฆู</option>
                                                    <option value="6">๐ ุงูุณุงุฏุณ ุงุจุชุฏุงุฆู</option>
                                                    <option value="7">๐ซ ุงูุฃูู ุฅุนุฏุงุฏู</option>
                                                    <option value="8">๐ฏ ุงูุซุงูู ุฅุนุฏุงุฏู</option>
                                                    <option value="9">๐ ุงูุซุงูุซ ุฅุนุฏุงุฏู</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="bulk_group" class="form-label">
                                                    <i class="fas fa-layer-group me-1"></i>
                                                    ุงูููุฌ (ููุฌููุน)
                                                </label>
                                                <select class="form-select form-select-lg" id="bulk_group" name="bulk_group" required>
                                                    <option value="1">๐ฅ ุงูููุฌ ุงูุฃูู</option>
                                                    <option value="2">๐ฅ ุงูููุฌ ุงูุซุงูู</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-success btn-lg">
                                                <i class="fas fa-users-plus me-2"></i>
                                                โ ุฅุถุงูุฉ ุฌููุน ุงููุดุงุฑููู
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer bg-light">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>
                                ุฅูุบุงุก
                            </button>
                            <div class="text-muted small">
                                <i class="fas fa-lightbulb me-1"></i>
                                ูุตูุญุฉ: ููููู ุฅุถุงูุฉ ูุดุงุฑู ูุงุญุฏ ุฃู ุนุฏุฉ ูุดุงุฑููู ูู ููุณ ุงูููุช
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Select Participants Modal -->
            <div class="modal fade" id="selectParticipantsModal" tabindex="-1" aria-labelledby="selectParticipantsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="selectParticipantsModalLabel">
                                <i class="fas fa-users text-primary me-2"></i> ุงุฎุชูุงุฑ ุงููุดุงุฑููู
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ุฅุบูุงู"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="searchParticipants" placeholder="๐ ุงูุจุญุซ ุนู ูุดุงุฑู...">
                            </div>
                            <div class="row" id="participantsList">
                                {% for participant in participants %}
                                <div class="col-md-6 mb-2 participant-item" data-name="{{ participant.name|lower }}">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body p-2">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                        <span class="fw-bold">{{ participant.name|slice:":1"|upper }}{{ participant.name|slice:"1:2"|upper }}</span>
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">๐งโ๐ {{ participant.name|slice:":1"|upper }}{{ participant.name|slice:"1:2"|upper }}.</h6>
                                                    <small class="text-muted">{{ participant.get_grade_display|slice:":6" }} - {{ participant.get_group_display|slice:":6" }}</small>
                                                </div>
                                                <div>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="selectParticipant('{{ participant.id }}', '๐งโ๐ {{ participant.name|slice:":1"|upper }}{{ participant.name|slice:"1:2"|upper }}. ({{ participant.get_grade_display|slice:":6" }})')">
                                                        ุงุฎุชูุงุฑ
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12 text-center">
                                    <p class="text-muted">ูุง ููุฌุฏ ูุดุงุฑููู ูุณุฌููู</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅุบูุงู</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Participants Modal -->
            <div class="modal fade" id="manageParticipantsModal" tabindex="-1" aria-labelledby="manageParticipantsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="manageParticipantsModalLabel">
                                <i class="fas fa-user-minus text-warning me-2"></i> ุฅุฏุงุฑุฉ ุงููุดุงุฑููู
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ุฅุบูุงู"></button>
                        </div>
                        <div class="modal-body">
                            <form id="delete-participants-form" action="{% url 'competitions:delete_multiple_participants' %}" method="post">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="searchManageParticipants" placeholder="๐ ุงูุจุญุซ ุนู ูุดุงุฑู ููุญุฐู...">
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllParticipants()">ุชุญุฏูุฏ ุงููู</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllParticipants()">ุฅูุบุงุก ุงูุชุญุฏูุฏ</button>
                                </div>
                                <div class="row" id="manageParticipantsList">
                                    {% for participant in participants %}
                                    <div class="col-md-6 mb-2 manage-participant-item" data-name="{{ participant.name|lower }}">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-body p-2">
                                                <div class="d-flex align-items-center">
                                                    <div class="me-2">
                                                        <input type="checkbox" name="participant_ids" value="{{ participant.id }}" class="form-check-input">
                                                    </div>
                                                    <div class="me-3">
                                                        <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                                                            <span class="fw-bold small">{{ participant.name|slice:":1"|upper }}{{ participant.name|slice:"1:2"|upper }}</span>
                                                        </div>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1">๐งโ๐ {{ participant.name|slice:":1"|upper }}{{ participant.name|slice:"1:2"|upper }}.</h6>
                                                        <small class="text-muted">{{ participant.get_grade_display|slice:":6" }} - {{ participant.get_group_display|slice:":6" }}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="col-12 text-center">
                                        <p class="text-muted">ูุง ููุฌุฏ ูุดุงุฑููู ูุณุฌููู</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                            <button type="submit" form="delete-participants-form" class="btn btn-danger" onclick="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงููุดุงุฑููู ุงููุญุฏุฏููุ\n\nโ๏ธ ุณูุชู ุญุฐู ุฌููุน ูุณุงุจูุงุชูู ุฃูุถุงู ููุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')">
                                <i class="fas fa-trash-alt me-2"></i> ๐๏ธ ุญุฐู ุงููุญุฏุฏูู
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer text-center py-3">
                <div class="small">
                    ุณูุชู ุชูุฏูู 15 ุณุคุงูุงู ููุ ูุฏุฉ ูู ุณุคุงู 15 ุซุงููุฉ
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add form validation to ensure a participant is selected
        const competitionForm = document.getElementById('competition-form');
        const startBtn = document.getElementById('start-competition-btn');

        console.log('๐ง Form elements found:');
        console.log('- Competition form:', competitionForm);
        console.log('- Start button:', startBtn);

        // Form validation on submit - ูุญุฏุซ ูููุธุงู ุงููุฑูู ุงูุฌุฏูุฏ
        competitionForm.addEventListener('submit', function(e) {
            const participantIdInput = document.getElementById('participant_id');
            const difficultyRadios = document.querySelectorAll('input[name="difficulty"]:checked');

            // Check if participant is selected (ุงููุธุงู ุงููุฑูู ุงูุฌุฏูุฏ)
            if (!participantIdInput || participantIdInput.value === '') {
                e.preventDefault();
                alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูุดุงุฑู ูุจู ุจุฏุก ุงููุณุงุจูุฉ');
                console.error('ูู ูุชู ุงุฎุชูุงุฑ ูุดุงุฑู');
                return false;
            }

            // Check if difficulty level is selected
            if (difficultyRadios.length === 0) {
                e.preventDefault();
                alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูุณุชูู ุงูุตุนูุจุฉ ูุจู ุจุฏุก ุงููุณุงุจูุฉ');
                console.error('ูู ูุชู ุงุฎุชูุงุฑ ูุณุชูู ุงูุตุนูุจุฉ');
                return false;
            }

            // Debug: Log the selected values
            console.log('๐ Form submission starting...');
            console.log('Selected participant ID:', participantIdInput.value);
            console.log('Selected difficulty:', difficultyRadios[0].value);
            console.log('Form action:', competitionForm.action);
            console.log('Form method:', competitionForm.method);

            // ุฅุถุงูุฉ ุชุฃููุฏ ุจุตุฑู
            const submitBtn = document.getElementById('start-competition-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ุฌุงุฑู ุจุฏุก ุงููุณุงุจูุฉ...';
                console.log('โ Submit button disabled and text updated');
            }

            console.log('โ Form validation passed, proceeding with submission...');
        });

        // Add visual feedback for difficulty selection
        const difficultyInputs = document.querySelectorAll('input[name="difficulty"]');
        difficultyInputs.forEach(input => {
            input.addEventListener('change', function() {
                // Remove previous selection styling
                document.querySelectorAll('.form-check.card').forEach(card => {
                    card.classList.remove('border-primary', 'bg-light');
                });

                // Add styling to selected card
                if (this.checked) {
                    const parentCard = this.closest('.form-check.card');
                    parentCard.classList.add('border-primary', 'bg-light');

                    // Show selected level in console for debugging
                    console.log('Difficulty level selected:', this.value);
                }
            });
        });

        // Initialize the first difficulty level as selected visually
        const firstDifficultyInput = document.getElementById('difficulty1');
        if (firstDifficultyInput && firstDifficultyInput.checked) {
            const parentCard = firstDifficultyInput.closest('.form-check.card');
            parentCard.classList.add('border-primary', 'bg-light');
        }

        // Search functionality for participants selection modal
        const searchParticipants = document.getElementById('searchParticipants');
        if (searchParticipants) {
            searchParticipants.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const participantItems = document.querySelectorAll('.participant-item');

                participantItems.forEach(item => {
                    const name = item.getAttribute('data-name');
                    if (name.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Search functionality for manage participants modal
        const searchManageParticipants = document.getElementById('searchManageParticipants');
        if (searchManageParticipants) {
            searchManageParticipants.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const participantItems = document.querySelectorAll('.manage-participant-item');

                participantItems.forEach(item => {
                    const name = item.getAttribute('data-name');
                    if (name.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Direct click handler for the start button - ูุญุฏุซ ูููุธุงู ุงููุฑูู ุงูุฌุฏูุฏ
        if (startBtn) {
            console.log('Start button found:', startBtn);
            // ูุง ูุญุชุงุฌ ููุนุงูุฌ ูููุตู ููููุฑุ ุงููููุฐุฌ ุณูุชู ุฅุฑุณุงูู ุชููุงุฆูุงู
            console.log('Start button configured for hierarchical system');
        } else {
            console.log('Start button not found!');
        }
        // Sorting participants by level
        document.getElementById('sortByLevelBtn').addEventListener('click', function() {
            const select = document.getElementById('participantSelect');
            const options = Array.from(select.options).filter(option => option.value !== "");

            // Sort options by grade (level)
            options.sort((a, b) => {
                const gradeA = parseInt(a.getAttribute('data-grade'));
                const gradeB = parseInt(b.getAttribute('data-grade'));
                return gradeA - gradeB;
            });

            // Remove current options (except the first disabled one)
            for (let i = select.options.length - 1; i > 0; i--) {
                select.remove(i);
            }

            // Add sorted options
            options.forEach(option => {
                select.add(option);
            });
        });

        // Form validation
        document.getElementById('participantForm').addEventListener('submit', function(e) {
            const singleTabActive = document.getElementById('single-tab').classList.contains('active');
            const excelTabActive = document.getElementById('excel-tab').classList.contains('active');

            if (singleTabActive) {
                const name = document.getElementById('new_participant_name').value.trim();
                const grade = document.getElementById('grade').value;

                if (!name || !grade) {
                    e.preventDefault();
                    alert('ุงูุฑุฌุงุก ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
                }
            } else if (excelTabActive) {
                const file = document.getElementById('participant_file').files[0];

                if (!file) {
                    e.preventDefault();
                    alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู Excel ุฃู CSV');
                }
            }
        });
    });

    // Function to download a sample Excel file template
    function downloadSampleFile() {
        // Code to download sample Excel template
        alert('ุณูุชู ุชูููุฑ ูููุฐุฌ ููุชุญููู ูุฑูุจุง');
    }

    // Function to filter participants by grade level
    function filterParticipantsByGrade() {
        const gradeFilter = document.getElementById('gradeFilter').value;
        if (!gradeFilter) {
            alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุณุชูู ุงูุฏุฑุงุณู');
            return;
        }
        // Redirect to the same page with the grade filter parameter
        window.location.href = `{% url 'competitions:start_competition' %}?grade=${gradeFilter}`;
    }

    // Add fullscreen toggle button
    document.addEventListener('DOMContentLoaded', function() {
        // Create fullscreen button
        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'btn btn-outline-light position-absolute';
        fullscreenBtn.style.top = '10px';
        fullscreenBtn.style.left = '10px';
        fullscreenBtn.style.zIndex = '1000';
        fullscreenBtn.id = 'fullscreen-btn';

        // Add to the card header
        const cardHeader = document.querySelector('.card-header');
        cardHeader.style.position = 'relative';
        cardHeader.appendChild(fullscreenBtn);

        // Update button based on current fullscreen state
        if (document.fullscreenElement || localStorage.getItem('fullscreenMode') === 'true') {
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            fullscreenBtn.title = 'ุฅูุบุงุก ููุก ุงูุดุงุดุฉ';
        } else {
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = 'ููุก ุงูุดุงุดุฉ';
        }

        // Add fullscreen functionality
        fullscreenBtn.addEventListener('click', function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen mode: ${err.message}`);
                });
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                fullscreenBtn.title = 'ุฅูุบุงุก ููุก ุงูุดุงุดุฉ';
                localStorage.setItem('fullscreenMode', 'true');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                    fullscreenBtn.title = 'ููุก ุงูุดุงุดุฉ';
                    localStorage.setItem('fullscreenMode', 'false');
                }
            }

            // Keep the fullscreen button visible for a few seconds after clicking
            fullscreenBtn.style.opacity = '1';
            clearTimeout(window.hideButtonTimeout);
            window.hideButtonTimeout = setTimeout(() => {
                fullscreenBtn.style.opacity = '0';
                fullscreenBtn.style.transition = 'opacity 0.5s';
            }, 3000);
        });

        // Show the button when mouse moves
        document.addEventListener('mousemove', function() {
            fullscreenBtn.style.opacity = '1';
            clearTimeout(window.hideButtonTimeout);
            window.hideButtonTimeout = setTimeout(() => {
                fullscreenBtn.style.opacity = '0';
            }, 3000);
        });

        // Initially hide the button after 3 seconds
        setTimeout(() => {
            fullscreenBtn.style.opacity = '0';
            fullscreenBtn.style.transition = 'opacity 0.5s';
        }, 3000);
    });
    function downloadSampleFile() {
        // Create CSV content
        const csvContent = 'name,grade,group\nุทุงูุจ ูููุฐุฌ 1,1,1\nุทุงูุจ ูููุฐุฌ 2,2,1\nุทุงูุจ ูููุฐุฌ 3,3,2\nุทุงูุจ ูููุฐุฌ 4,4,2';

        // Create a blob with the CSV content
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

        // Create a download link and trigger the download
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'participants_template.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Function to toggle all checkboxes
    function toggleAllCheckboxes() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const participantCheckboxes = document.querySelectorAll('.participant-checkbox');

        participantCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });

        updateDeleteButton();
    }

    // Function to update delete button state
    function updateDeleteButton() {
        const participantCheckboxes = document.querySelectorAll('.participant-checkbox:checked');
        const deleteButton = document.getElementById('delete-selected-btn');

        deleteButton.disabled = participantCheckboxes.length === 0;
    }

    // Function to select a participant from the modal
    function selectParticipant(participantId, participantDisplayName) {
        const participantSelect = document.getElementById('participantSelect');
        participantSelect.value = participantId;

        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('selectParticipantsModal'));
        modal.hide();

        // Show success message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
        alertDiv.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            ุชู ุงุฎุชูุงุฑ ุงููุดุงุฑู: <strong>${participantDisplayName}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        const cardBody = document.querySelector('.card-body');
        cardBody.insertBefore(alertDiv, cardBody.firstChild);

        // Auto-remove alert after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }

    // Function to select all participants in manage modal
    function selectAllParticipants() {
        const checkboxes = document.querySelectorAll('#manageParticipantsList input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
    }

    // Function to deselect all participants in manage modal
    function deselectAllParticipants() {
        const checkboxes = document.querySelectorAll('#manageParticipantsList input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    }

    // ุฅุตูุงุญ ูุดุงูู ุงูููุงูุฐ ุงูููุจุซูุฉ
    document.addEventListener('DOMContentLoaded', function() {
        // ุชุฃูุฏ ูู ุชุญููู Bootstrap ุจุดูู ุตุญูุญ
        if (typeof bootstrap !== 'undefined') {
            console.log('Bootstrap loaded successfully');

            // ุฅุนุงุฏุฉ ุชููุฆุฉ ุฌููุน ุงูููุงูุฐ ุงูููุจุซูุฉ
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                // ุชุฃูุฏ ูู ุงูุฅุนุฏุงุฏุงุช ุงูุตุญูุญุฉ
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.zIndex = '1055';
                modal.style.width = '100%';
                modal.style.height = '100%';

                // ุฅุถุงูุฉ event listeners
                modal.addEventListener('show.bs.modal', function() {
                    console.log('Modal showing:', modal.id);
                    document.body.style.overflow = 'hidden';
                });

                modal.addEventListener('hidden.bs.modal', function() {
                    console.log('Modal hidden:', modal.id);
                    document.body.style.overflow = 'auto';
                });
            });

            // ุฅุตูุงุญ ูุดููุฉ backdrop
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                backdrop.style.position = 'fixed';
                backdrop.style.top = '0';
                backdrop.style.left = '0';
                backdrop.style.width = '100vw';
                backdrop.style.height = '100vh';
                backdrop.style.zIndex = '1050';
            });
        } else {
            console.error('Bootstrap not loaded!');
        }
    });

    // Function to clear all participants
    function clearAllParticipants() {
        if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงููุดุงุฑูููุ\n\nโ๏ธ ุณูุชู ุญุฐู ุฌููุน ูุณุงุจูุงุชูู ุฃูุถุงู ููุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "competitions:clear_all_participants" %}';

            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
        }
    }

    // JavaScript ูููุงูุฐุฉ ุงูุฌุฏูุฏุฉ ุงููุญุณูุฉ
    document.addEventListener('DOMContentLoaded', function() {
        // ุชุญุณูู ุชุฌุฑุจุฉ ุงููุงูุฐุฉ ุงูุฌุฏูุฏุฉ
        const newModal = document.getElementById('newAddParticipantModal');
        const singleForm = document.getElementById('singleParticipantForm');
        const multipleForm = document.getElementById('multipleParticipantsForm');

        // ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุฐุฌ ุนูุฏ ูุชุญ ุงููุงูุฐุฉ
        if (newModal) {
            newModal.addEventListener('show.bs.modal', function() {
                // ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุฐุฌ
                if (singleForm) singleForm.reset();
                if (multipleForm) multipleForm.reset();

                // ุงูุชุฑููุฒ ุนูู ุงูุญูู ุงูุฃูู
                setTimeout(() => {
                    const firstInput = document.getElementById('single_name');
                    if (firstInput) firstInput.focus();
                }, 300);
            });
        }

        // ุชุญุณูู ุชุฌุฑุจุฉ ุงูุฅุถุงูุฉ ุงูุฌูุงุนูุฉ
        const participantsTextarea = document.getElementById('participants_text');
        if (participantsTextarea) {
            participantsTextarea.addEventListener('input', function() {
                const lines = this.value.split('\n').filter(line => line.trim());
                const count = lines.length;

                // ุฅุธูุงุฑ ุนุฏุฏ ุงููุดุงุฑููู
                let countDisplay = this.parentElement.querySelector('.participant-count');
                if (!countDisplay) {
                    countDisplay = document.createElement('div');
                    countDisplay.className = 'participant-count text-muted small mt-1';
                    this.parentElement.appendChild(countDisplay);
                }

                if (count > 0) {
                    countDisplay.innerHTML = `<i class="fas fa-users me-1"></i>ุนุฏุฏ ุงููุดุงุฑููู: ${count}`;
                } else {
                    countDisplay.innerHTML = '';
                }
            });
        }

        // ุชุญุณูู ุงูุชุจุฏูู ุจูู ุงูุชุจููุจุงุช
        const tabButtons = document.querySelectorAll('#addParticipantTabs button');
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                setTimeout(() => {
                    if (this.id === 'single-participant-tab') {
                        const nameInput = document.getElementById('single_name');
                        if (nameInput) nameInput.focus();
                    } else if (this.id === 'multiple-participants-tab') {
                        const textArea = document.getElementById('participants_text');
                        if (textArea) textArea.focus();
                    }
                }, 100);
            });
        });

        // ุชุญุณูู ุฅุฑุณุงู ุงูููุงุฐุฌ ูุน AJAX
        if (singleForm) {
            singleForm.addEventListener('submit', function(e) {
                e.preventDefault(); // ููุน ุงูุฅุฑุณุงู ุงูุนุงุฏู

                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ุฌุงุฑู ุงูุฅุถุงูุฉ...';
                }

                // ุฅุฑุณุงู ุงูุจูุงูุงุช ุจู AJAX
                const formData = new FormData(this);
                formData.append('from_new_modal', 'true');

                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(html => {
                    // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุฅุธูุงุฑ ุงููุดุงุฑููู ุงูุฌุฏุฏ
                    window.location.reload();
                })
                .catch(error => {
                    console.error('ุฎุทุฃ ูู ุฅุถุงูุฉ ุงููุดุงุฑู:', error);
                    // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูู ุญุงูุฉ ุงูุฎุทุฃ
                    window.location.reload();
                });
            });
        }

        if (multipleForm) {
            multipleForm.addEventListener('submit', function(e) {
                e.preventDefault(); // ููุน ุงูุฅุฑุณุงู ุงูุนุงุฏู

                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ุฌุงุฑู ุฅุถุงูุฉ ุงููุดุงุฑููู...';
                }

                // ุฅุฑุณุงู ุงูุจูุงูุงุช ุจู AJAX
                const formData = new FormData(this);
                formData.append('from_new_modal', 'true');

                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(html => {
                    // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุฅุธูุงุฑ ุงููุดุงุฑููู ุงูุฌุฏุฏ
                    window.location.reload();
                })
                .catch(error => {
                    console.error('ุฎุทุฃ ูู ุฅุถุงูุฉ ุงููุดุงุฑููู:', error);
                    // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูู ุญุงูุฉ ุงูุฎุทุฃ
                    window.location.reload();
                });
            });
        }

        // ุฅุบูุงู ุงููุงูุฐุฉ ูุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ุนูุฏ ุงููุฌุงุญ
        function handleSuccessfulAddition() {
            // ุฅุบูุงู ุงููุงูุฐุฉ
            const modal = bootstrap.Modal.getInstance(newModal);
            if (modal) {
                modal.hide();
            }

            // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุฅุธูุงุฑ ุงููุดุงุฑููู ุงูุฌุฏุฏ
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }

        // ุงูุชุญูู ูู ุฑุณุงุฆู ุงููุฌุงุญ ูุฅุบูุงู ุงููุงูุฐุฉ
        const successMessages = document.querySelectorAll('.alert-success');
        const modalCloseSignal = document.querySelector('.alert-info');

        if (successMessages.length > 0 && modalCloseSignal && modalCloseSignal.textContent.includes('modal_success_close')) {
            // ุฅุฐุง ูุงูุช ููุงู ุฑุณุงูุฉ ูุฌุงุญ ูู ุงููุงูุฐุฉ ุงูุฌุฏูุฏุฉุ ุฃุบูู ุงููุงูุฐุฉ ูุฃุนุฏ ุชุญููู ุงูุตูุญุฉ
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(newModal);
                if (modal) {
                    modal.hide();
                }

                // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุฅุธูุงุฑ ุงููุดุงุฑููู ุงูุฌุฏุฏ
                setTimeout(() => {
                    window.location.reload();
                }, 300);
            }, 1500);
        }

        // ุงููุธุงู ุงููุฑูู ุงูุฌุฏูุฏ ูุงุฎุชูุงุฑ ุงููุดุงุฑููู
        const gradeFilter = document.getElementById('gradeFilter');
        const participantSelectionCard = document.getElementById('participantSelectionCard');
        const difficultySelectionCard = document.getElementById('difficultySelectionCard');
        const participantsGrid = document.getElementById('participantsGrid');
        const participantsLoadingMessage = document.getElementById('participantsLoadingMessage');
        const noParticipantsMessage = document.getElementById('noParticipantsMessage');
        const selectedParticipantDisplay = document.getElementById('selectedParticipantDisplay');
        const selectedParticipantText = document.getElementById('selectedParticipantText');
        const participantIdInput = document.getElementById('participant_id');

        // ุชุนููู ูุณุชูู ุงูุตุนูุจุฉ ุชููุงุฆูุงู ุญุณุจ ุงููุณุชูู ุงูุฏุฑุงุณู
        function setAutomaticDifficulty(grade) {
            // ุฎุฑูุทุฉ ุงููุณุชููุงุช ุงูุฏุฑุงุณูุฉ ุฅูู ูุณุชููุงุช ุงูุตุนูุจุฉ
            const gradeTodifficulty = {
                '3': '3',  // ุงูุซุงูุซ ุงุจุชุฏุงุฆู -> ูุณุชูู ุตุนูุจุฉ 3
                '4': '4',  // ุงูุฑุงุจุน ุงุจุชุฏุงุฆู -> ูุณุชูู ุตุนูุจุฉ 4
                '5': '5',  // ุงูุฎุงูุณ ุงุจุชุฏุงุฆู -> ูุณุชูู ุตุนูุจุฉ 5
                '6': '6',  // ุงูุณุงุฏุณ ุงุจุชุฏุงุฆู -> ูุณุชูู ุตุนูุจุฉ 6
                '7': '7',  // ุงูุฃูู ูุชูุณุท -> ูุณุชูู ุตุนูุจุฉ 7
                '8': '8',  // ุงูุซุงูู ูุชูุณุท -> ูุณุชูู ุตุนูุจุฉ 8
                '9': '9'   // ุงูุซุงูุซ ูุชูุณุท -> ูุณุชูู ุตุนูุจุฉ 9
            };

            const targetDifficulty = gradeTodifficulty[grade];
            if (targetDifficulty) {
                // ุฅูุบุงุก ุชุญุฏูุฏ ุฌููุน ูุณุชููุงุช ุงูุตุนูุจุฉ
                document.querySelectorAll('input[name="difficulty"]').forEach(radio => {
                    radio.checked = false;
                });

                // ุชุญุฏูุฏ ุงููุณุชูู ุงูููุงุณุจ
                const targetRadio = document.querySelector(`input[name="difficulty"][value="${targetDifficulty}"]`);
                if (targetRadio) {
                    targetRadio.checked = true;

                    // ุฅุฎูุงุก ูุณู ุงุฎุชูุงุฑ ูุณุชูู ุงูุตุนูุจุฉ ูุฃูู ุชู ุชุนูููู ุชููุงุฆูุงู
                    const difficultySelectionCard = document.getElementById('difficultySelectionCard');
                    if (difficultySelectionCard) {
                        difficultySelectionCard.style.display = 'none';
                    }

                    // ุฅุธูุงุฑ ุฑุณุงูุฉ ุชูุถูุญูุฉ
                    if (window.notifications) {
                        notifications.info(`ุชู ุชุนููู ูุณุชูู ุงูุตุนูุจุฉ ${targetDifficulty} ุชููุงุฆูุงู ูููุณุชูู ุงูุฏุฑุงุณู ุงููุฎุชุงุฑ`);
                    }

                    console.log(`ุชู ุชุนููู ูุณุชูู ุงูุตุนูุจุฉ ${targetDifficulty} ูููุณุชูู ุงูุฏุฑุงุณู ${grade}`);
                }
            }
        }

        // ุชุตููุฉ ุงููุดุงุฑููู ุญุณุจ ุงููุณุชูู ุงููุฎุชุงุฑ
        if (gradeFilter) {
            gradeFilter.addEventListener('change', function() {
                const selectedGrade = this.value;
                if (selectedGrade) {
                    // ุชุนููู ูุณุชูู ุงูุตุนูุจุฉ ุชููุงุฆูุงู
                    setAutomaticDifficulty(selectedGrade);

                    // ุฌูุจ ุงููุดุงุฑููู
                    fetchParticipantsByGrade(selectedGrade);
                } else {
                    hideParticipantsList();

                    // ูุณุญ ุชุญุฏูุฏ ูุณุชูู ุงูุตุนูุจุฉ
                    document.querySelectorAll('input[name="difficulty"]').forEach(radio => {
                        radio.checked = false;
                    });
                }
            });
        }

        // ุฌูุจ ุงููุดุงุฑููู ุญุณุจ ุงููุณุชูู ุนุจุฑ AJAX
        function fetchParticipantsByGrade(grade) {
            // ุฅุธูุงุฑ ุฑุณุงูุฉ ุงูุชุญููู
            participantSelectionCard.style.display = 'block';
            participantsLoadingMessage.style.display = 'block';
            participantsGrid.style.display = 'none';
            noParticipantsMessage.style.display = 'none';
            selectedParticipantDisplay.style.display = 'none';

            // ุฅุฑุณุงู ุทูุจ AJAX
            fetch(`{% url 'competitions:get_participants_by_grade' %}?grade=${grade}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                participantsLoadingMessage.style.display = 'none';

                if (data.success && data.participants.length > 0) {
                    displayParticipants(data.participants);
                } else {
                    showNoParticipantsMessage();
                }
            })
            .catch(error => {
                console.error('ุฎุทุฃ ูู ุฌูุจ ุงููุดุงุฑููู:', error);
                participantsLoadingMessage.style.display = 'none';
                showNoParticipantsMessage();
            });
        }

        // ูุชุบูุฑุงุช ุงูุจุญุซ
        let allParticipants = [];
        let filteredParticipants = [];

        // ุนุฑุถ ุงููุดุงุฑููู ูู ุงูุดุจูุฉ
        function displayParticipants(participants) {
            // ุญูุธ ุฌููุน ุงููุดุงุฑููู ููุจุญุซ
            allParticipants = participants;
            filteredParticipants = participants;

            renderParticipants(participants);

            // ุฅุธูุงุฑ ูุฑุจุน ุงูุจุญุซ ูุงูุนุฏุงุฏ
            const searchContainer = document.getElementById('participantSearchContainer');
            const counterContainer = document.getElementById('participantsCounter');
            const participantsInfo = document.getElementById('participantsInfo');

            if (searchContainer) searchContainer.style.display = 'block';
            if (counterContainer) counterContainer.style.display = 'block';
            if (participantsInfo) participantsInfo.style.display = 'block';

            // ุชุญุฏูุซ ุงูุนุฏุงุฏ
            updateParticipantsCounter(participants.length);

            // ุฅุนุฏุงุฏ ุงูุจุญุซ
            setupParticipantSearch();
        }

        // ุฑุณู ุงููุดุงุฑููู
        function renderParticipants(participants) {
            participantsGrid.innerHTML = '';

            participants.forEach(participant => {
                const participantCard = createParticipantCard(participant);
                participantsGrid.appendChild(participantCard);
            });

            participantsGrid.style.display = 'block';

            // ุฅุฎูุงุก/ุฅุธูุงุฑ ุฑุณุงูุฉ ุนุฏู ูุฌูุฏ ูุชุงุฆุฌ
            const noSearchResults = document.getElementById('noSearchResults');
            if (participants.length === 0 && allParticipants.length > 0) {
                noSearchResults.style.display = 'block';
                participantsGrid.style.display = 'none';
            } else {
                noSearchResults.style.display = 'none';
            }
        }

        // ุชุญุฏูุซ ุนุฏุงุฏ ุงููุดุงุฑููู
        function updateParticipantsCounter(count) {
            const counter = document.getElementById('participantsCount');
            if (counter) {
                counter.textContent = count;
            }
        }

        // ุฅุนุฏุงุฏ ูุธููุฉ ุงูุจุญุซ
        function setupParticipantSearch() {
            const searchInput = document.getElementById('participantSearchInput');
            if (!searchInput) return;

            // ุฅุฒุงูุฉ ุงููุณุชูุนูู ุงูุณุงุจููู
            searchInput.removeEventListener('input', handleParticipantSearch);
            searchInput.removeEventListener('keyup', handleParticipantSearch);

            // ุฅุถุงูุฉ ูุณุชูุน ุฌุฏูุฏ
            searchInput.addEventListener('input', handleParticipantSearch);
            searchInput.addEventListener('keyup', handleParticipantSearch);
        }

        // ูุนุงูุฌ ุงูุจุญุซ
        function handleParticipantSearch(event) {
            const searchTerm = event.target.value.trim().toLowerCase();

            if (searchTerm === '') {
                // ุฅุธูุงุฑ ุฌููุน ุงููุดุงุฑููู
                filteredParticipants = allParticipants;
                renderParticipants(allParticipants);
                updateParticipantsCounter(allParticipants.length);
            } else {
                // ุชุตููุฉ ุงููุดุงุฑููู
                filteredParticipants = allParticipants.filter(participant =>
                    participant.name.toLowerCase().includes(searchTerm)
                );

                // ุชุญุฏูุซ ุงููุต ูู ุฑุณุงูุฉ ุนุฏู ูุฌูุฏ ูุชุงุฆุฌ
                const searchTermSpan = document.getElementById('searchTerm');
                if (searchTermSpan) {
                    searchTermSpan.textContent = event.target.value;
                }

                renderParticipants(filteredParticipants);
                updateParticipantsCounter(filteredParticipants.length);
            }
        }

        // ูุณุญ ุงูุจุญุซ
        window.clearParticipantSearch = function() {
            const searchInput = document.getElementById('participantSearchInput');
            if (searchInput) {
                searchInput.value = '';
                filteredParticipants = allParticipants;
                renderParticipants(allParticipants);
                updateParticipantsCounter(allParticipants.length);
                searchInput.focus();
            }
        }

        // ุฅูุดุงุก ุจุทุงูุฉ ูุดุงุฑู ูุญุณูุฉ
        function createParticipantCard(participant) {
            const col = document.createElement('div');
            col.className = 'col-6 col-sm-4 col-md-3 col-lg-3 col-xl-3 mb-2';

            // ุชูุณูู ุงูุงุณู ุฅูู ูููุงุช ูุชูุฒูุนูุง ุนูู 4 ุฃุณุทุฑ
            const nameWords = participant.name.split(' ');
            let nameLines = ['', '', '', ''];

            // ุชูุฒูุน ุงููููุงุช ุนูู ุงูุฃุณุทุฑ
            nameWords.forEach((word, index) => {
                const lineIndex = index % 4;
                if (nameLines[lineIndex] !== '') {
                    nameLines[lineIndex] += ' ';
                }
                nameLines[lineIndex] += word;
            });

            // ุฅูุดุงุก HTML ููุฃุณุทุฑ
            const nameHTML = nameLines
                .filter(line => line.trim() !== '')
                .map(line => `<div style="font-size: 0.7rem; line-height: 1.1; font-weight: 600;">${line}</div>`)
                .join('');

            col.innerHTML = `
                <div class="card participant-card h-100 border-0 shadow-sm" onclick="selectParticipantFromGrid(${participant.id}, '${participant.name}', '${participant.grade_display}', '${participant.group_display}')" style="cursor: pointer; transition: all 0.2s; border-radius: 8px; min-height: 120px;">
                    <div class="card-body text-center p-2 d-flex flex-column justify-content-between">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-1" style="width: 28px; height: 28px;">
                            <span class="fw-bold" style="font-size: 0.65rem;">${participant.initials}</span>
                        </div>
                        <div class="participant-name mb-1" title="${participant.name}" style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
                            ${nameHTML}
                        </div>
                        <div class="participant-info">
                            <small class="text-muted d-block" style="font-size: 0.6rem; line-height: 1;">
                                ${participant.short_grade}
                            </small>
                            <small class="text-muted d-block" style="font-size: 0.55rem;">
                                ${participant.short_group}
                            </small>
                        </div>
                    </div>
                </div>
            `;

            // ุฅุถุงูุฉ ุชุฃุซูุฑุงุช ุงูุชูุงุนู ูุญุณูุฉ
            const card = col.querySelector('.participant-card');
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-3px)';
                this.style.boxShadow = '0 6px 20px rgba(0,0,0,0.12)';
                this.style.borderColor = '#007bff';
            });

            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                this.style.borderColor = 'transparent';
            });

            return col;
        }

        // ุงุฎุชูุงุฑ ูุดุงุฑู ูู ุงูุดุจูุฉ
        window.selectParticipantFromGrid = function(participantId, participantName, gradeDisplay, groupDisplay) {
            // ุชุญุฏูุซ ุงูุญูู ุงููุฎูู
            participantIdInput.value = participantId;

            // ุนุฑุถ ุงููุดุงุฑู ุงููุฎุชุงุฑ
            selectedParticipantText.innerHTML = `
                <strong>${participantName}</strong> - ${gradeDisplay} - ${groupDisplay}
            `;
            selectedParticipantDisplay.style.display = 'block';

            // ูุง ูุญุชุงุฌ ูุฅุธูุงุฑ ูุณู ุงุฎุชูุงุฑ ูุณุชูู ุงูุตุนูุจุฉ ูุฃูู ูุชู ุชุนูููู ุชููุงุฆูุงู
            // difficultySelectionCard.style.display = 'block';

            // ุชูููุฒ ุงูุจุทุงูุฉ ุงููุฎุชุงุฑุฉ
            document.querySelectorAll('.participant-card').forEach(card => {
                card.classList.remove('selected', 'border-success', 'bg-light');
            });

            event.currentTarget.classList.add('selected');

            // ุงูุชูุฑูุฑ ุฅูู ูุณู ุงูุจุฏุก ูุจุงุดุฑุฉ (ูุฃู ุงูุตุนูุจุฉ ุชู ุชุนููููุง ุชููุงุฆูุงู)
            const startSection = document.getElementById('startCompetitionSection');
            if (startSection && startSection.style.display !== 'none') {
                startSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // ุงูุชุญูู ูู ุฅููุงููุฉ ุฅุธูุงุฑ ุฒุฑ ุงูุจุฏุก
            checkStartButtonVisibility();
        }

        // ูุณุญ ุงุฎุชูุงุฑ ุงููุดุงุฑู
        window.clearParticipantSelection = function() {
            participantIdInput.value = '';
            selectedParticipantDisplay.style.display = 'none';
            difficultySelectionCard.style.display = 'none';

            // ุฅุฒุงูุฉ ุงูุชูููุฒ ูู ุฌููุน ุงูุจุทุงูุงุช
            document.querySelectorAll('.participant-card').forEach(card => {
                card.classList.remove('selected', 'border-success', 'bg-light');
            });
        }

        // ุฅุฎูุงุก ูุงุฆูุฉ ุงููุดุงุฑููู
        function hideParticipantsList() {
            participantSelectionCard.style.display = 'none';
            difficultySelectionCard.style.display = 'none';

            // ุฅุฎูุงุก ุงูุฑุณุงูุฉ ุงูุชูุถูุญูุฉ ุฃูุถุงู
            const participantsInfo = document.getElementById('participantsInfo');
            if (participantsInfo) {
                participantsInfo.style.display = 'none';
            }

            clearParticipantSelection();
        }

        // ุนุฑุถ ุฑุณุงูุฉ ุนุฏู ูุฌูุฏ ูุดุงุฑููู
        function showNoParticipantsMessage() {
            participantsGrid.style.display = 'none';
            noParticipantsMessage.style.display = 'block';
        }

        // ุชุญุฏูุซ ูุงุฆูุฉ ุงููุดุงุฑููู
        window.refreshParticipants = function() {
            const selectedGrade = gradeFilter.value;
            if (selectedGrade) {
                fetchParticipantsByGrade(selectedGrade);
            }
        }

        // ุงูุชุญูู ูู ุฅููุงููุฉ ุฅุธูุงุฑ ุฒุฑ ุงูุจุฏุก
        function checkStartButtonVisibility() {
            const participantSelected = participantIdInput.value !== '';
            const difficultySelected = document.querySelector('input[name="difficulty"]:checked') !== null;
            const startSection = document.getElementById('startCompetitionSection');

            console.log('Checking start button visibility:');
            console.log('- Participant selected:', participantSelected, 'ID:', participantIdInput.value);
            console.log('- Difficulty selected:', difficultySelected);

            if (participantSelected && difficultySelected) {
                startSection.style.display = 'block';
                startSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                console.log('โ Start button shown');
            } else {
                startSection.style.display = 'none';
                console.log('โ Start button hidden');
            }
        }

        // ูุฑุงูุจุฉ ุชุบููุฑ ูุณุชูู ุงูุตุนูุจุฉ
        document.querySelectorAll('input[name="difficulty"]').forEach(radio => {
            radio.addEventListener('change', checkStartButtonVisibility);
        });

        // ุชุญููู ุงููุดุงุฑููู ุฅุฐุง ูุงู ููุงู ูุณุชูู ูุญุฏุฏ ูุณุจูุงู
        if (gradeFilter && gradeFilter.value) {
            fetchParticipantsByGrade(gradeFilter.value);
        }
    });
</script>

{% endblock %}

{% block extra_js %}
<!-- ุชุถููู ููู JavaScript ููุฅุดุนุงุฑุงุช -->
<script src="{% static 'js/notifications.js' %}"></script>
{% endblock %}